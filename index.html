<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:16px}
    .container{max-width:760px;margin:0 auto}
    h1{color:#fff;text-align:center;margin:10px 0 14px}
    .status{display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:12px;margin-bottom:10px}
    .pill{background:#eef2ff;color:#273c75;font-weight:800;border-radius:999px;padding:6px 10px;display:inline-block}
    .status a{color:#fff;text-decoration:underline;cursor:pointer;margin-left:10px}

    /* Tabulações */
    .tabs{
      exibição:flex;
      fundo:#000;
      raio-da-borda:14px;
      overflow:oculto;
      margem-inferior:12px;
      borda:1px sólida rgba(255,255,255,.15);
    }
    .tab{
      flex:1;
      borda:0;
      fundo:#000;
      cor:#fff;
      preenchimento:12px;
      peso da fonte: 900;
      cursor:ponteiro;
    }
    .tab.active{background:#007AFF;color:#fff}

    .card{background:rgba(255,255,255,.95);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);display:none}
    .card.active{display:block}
    label{display:block;font-weight:800;margin:12px 0 8px;color:#222}
    input,select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#007AFF}
    botão{largura:100%;borda:0;fundo:#007AFF;cor:#fff;preenchimento:12px 14px;raio da borda:12px;peso da fonte:900;tamanho da fonte:16px;cursor:ponteiro;margem superior:12px}
    botão.secundário{fundo:#2c2c2e}
    botão.perigo{fundo:#FF3B30}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .summary{background:#f2f2f7;border-radius:14px;padding:14px;text-align:center;margin:12px 0}
    .total{font-size:26px;font-weight:900;color:#FF3B30}
    .empty{color:#666;text-align:center;padding:26px 10px}
    .item{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .it-left{min-width:0;flex:1}
    .it-title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .it-sub{font-size:12px;color:#666;margin-top:4px}
    .it-val{font-weight:900;white-space:nowrap}
    .filters{display:flex;gap:10px;margin-bottom:12px}
    .filters select{flex:1}
    .export{display:flex;gap:10px;margin-top:12px}
    .export button{margin-top:0;flex:1;padding:10px}

    /* Relatório detalhado */
    .cats{margin-top:12px;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    Detalhes do .cats{border-bottom:1px solid #eee}
    Detalhes do .cats:último-filho{border-bottom:nenhum}
    .cats summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cats summary::-webkit-details-marker{display:none}
    .cat-name{font-weight:900;color:#111}
    .cat-meta{font-size:12px;color:#666;margin-top:3px}
    .cat-total{font-weight:900;color:#111;text-align:right}
    .cat-pct{font-size:12px;color:#666;text-align:right}
    .cat-items{padding:0 14px 12px}
    .cat-item{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-top:1px dashed #eee;font-size:13px}
    .cat-item .desc{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
    .cat-item .sub{font-size:12px;color:#666;margin-top:2px}
    .cat-item .val{font-weight:900;white-space:nowrap}

    /* Sobreposições */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .overlay.show{display:flex}
    .modal{width:100%;max-width:560px;background:rgba(255,255,255,.98);border-radius:18px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .modal h2{font-size:18px;margin-bottom:10px;color:#111}
    .note{font-size:12px;color:#555;margin-top:8px;line-height:1.35}
    .msg{font-size:12px;color:#c0392b;font-weight:900;margin-top:8px;min-height:16px}

    @media print{
      corpo{fundo:#fff;preenchimento:0}
      .tabs,.status,.overlay,.export{display:none!important}
      .card{box-shadow:none}
      .card{display:block}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="status">
      <div><span class="pill" id="syncStatus">Sincronização: desconectada</span></div>
      <div>
        <a id="btnChangePin" style="display:none">PIN do Trocar</a>
        <a id="btnLogout" style="display:none">Sair</a>
      </div>
    </div>

    <h1>Gastos</h1>

    <div class="tabs">
      <button class="tab active" data-tab="gastos">Gastos</button>
      <button class="tab" data-tab="ganhos">Ganhos</button>
      <button class="tab" data-tab="lista">Lista</button>
      <button class="tab" data-tab="relatório">Relatório</button>
    </div>

    <!-- GASTOS -->
    <section id="gastos" class="card active">
      <label>Dados</label>
      <input type="date" id="data">

      <label>Categoria</label>
      <select id="categoria">
        <option value="">Selecione...</option>
        <option>Alimentaço</option>
        <option>Transporte</option>
        <option>Mercado</option>
        <option>Contas</option>
        <option>Laser</option>
        <option>Comprar na internet</option>
        <option>Jogos</option>
        <option>Outros</option>
      </select>

      <label>Descrição</label>
      <input id="descricao" placeholder="Ex: cerveja, churrasco...">

      <label>Forma de pagamento</label>
      <select id="forma">
        <option value="">Selecione...</option>
        <option>Pixel</option>
        <option>Crédito</option>
        <option>Débito</option>
        <option>Espécie</option>
      </select>

      <label>Valor (R$)</label>
      <input type="text" id="valor" inputmode="decimal" placeholder="0,00">

      <button id="btnSalvar" type="button">Salvar gasto</button>
    </section>

    <!-- GANHOS -->
    <section id="ganhos" class="card">
      <label>Dados</label>
      <input type="date" id="dataGanho">

      <label>Tipo</label>
      <select id="tipoGanho">
        <option value="">Selecione...</option>
        <option>Salário</option>
        <option>Venda</option>
        <option>Manutenção</option>
        <option>Outros</option>
      </select>

      <label>Descrição</label>
      <input id="descGanho" placeholder="Ex: salário, venda iPhone, manutenção...">

      <label>Valor (R$)</label>
      <input type="text" id="valorGanho" inputmode="decimal" placeholder="0,00">

      <button id="btnSalvarGanho" type="button" onclick="__addGanho()">Salvar ganho</button>

      <div class="filters" style="margin-top:12px">
        <select id="ganhosMes"><option value="">Todos os meses</option></select>
      </div>

      <div class="summary" id="sumGanhosLista" style="display:none">
        <div>Total de ganhos (mais selecionados)</div>
        <div class="total" id="totalGanhosLista">R$ 0,00</div>
      </div>

      <div style="margin-top:12px" id="listaGanhos"></div>
      <div class="empty" id="emptyGanhos">Nenhum ganho ainda.</div>
    </section>

    <!-- LISTA -->
    <section id="lista" class="card">
      <div class="filters">
        <select id="filtroMes"><option value="">Todos os meses</option></select>
        <select id="filtroCat"><option value="">Todas as categorias</option></select>
      </div>

      <div class="summary" id="sumLista" style="display:none">
        <div>Total selecionado</div>
        <div class="total" id="totalLista">R$ 0,00</div>
      </div>

      <div id="listaGastos"></div>
      <div class="empty" id="emptyLista">Nenhum gasto ainda.</div>
    </section>

    <!-- RELATÓRIO -->
    <section id="relatorio" class="card">
      <div class="filters">
        <select id="relatorioMes"><option value="">Selecione um mÃªs</option></select>
      </div>

      <div class="summary" id="sumRel" style="display:none">
        <div>Total de mais (gastos)</div>
        <div class="total" id="totalRel">R$ 0,00</div>
      </div>

      <div class="summary" id="sumGanhos" style="display:none">
        <div>Total de ganhos do mês</div>
        <div class="total" id="totalGanhos">R$ 0,00</div>
      </div>

      <div class="summary" id="sumSaldo" style="display:none">
        <div>Saldo do mês (ganhos - gastos)</div>
        <div class="total" id="saldoMes">R$ 0,00</div>
      </div>

      <div id="detalheCategorias" class="cats" style="display:none"></div>

      <div class="export" id="exportBtns" style="display:none">
        <button id="btnPdf" type="button">ðŸ“„ Gerar PDF</button>
      </div>

      <div class="empty" id="emptyRel">Selecione um mês para ver o relatório.</div>
      <div class="note" id="infoRel" style="display:none;text-align:center"></div>
    </section>
  </div>

  <!-- LOGIN -->
  <div class="overlay" id="loginOverlay">
    <div class="modal">
      <h2>Entrar para sincronizar</h2>

      <div class="row">
        <button id="btnGoogle" type="button">Entrar no Google</button>
        <button class="secondary" id="btnToggleEmail" type="button">Email/senha</button>
      </div>

      <div id="emailBox" style="display:none;margin-top:12px">
        <label>E-mail</label>
        <input id="authEmail" type="email" autocomplete="email">

        <label>Senha</label>
        <input id="authPass" type="password" autocomplete="senha-atual">

        <div class="row">
          <button id="btnEntrar" type="button">Entrar</button>
          <button class="secondary" id="btnCriar" type="button">Criar conta</button>
        </div>
      </div>

      <div class="msg" id="authMsg"></div>
      <div class="note">Depois do login, você cria/digita um PIN para travar este navegador.</div>
    </div>
  </div>

  <!-- PIN -->
  <div class="overlay" id="pinOverlay">
    <div class="modal">
      <h2>Fixar este navegador</h2>

      <div id="pinSet" style="display:none">
        <label>Crie um PIN (4 a 8 dígitos)</label>
        <input id="pinNovo" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <label style="margin-top:10px">Repita o PIN</label>
        <input id="pinNovo2" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <button id="btnSalvarPin" type="button">Salvar PIN</button>
      </div>

      <div id="pinEnter" style="display:none">
        <label>Digite seu PIN</label>
        <input id="pinDigitado" inputmode="numeric" pattern="[0-9]*" placeholder="•••">
        <button id="btnDesbloquear" type="button">Desbloquear</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="danger" id="btnEsqueciPin" type="button">Esqueci o PIN</button>
        <button class="secondary" id="btnLimparPin" type="button">Limpar PIN deste navegador</button>
      </div>

      <div class="msg" id="pinMsg"></div>
      <div class="note">Para redefinir o PIN, você precisa confirmar sua conta do Google.</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    importar {
      obterAuth, onAuthStateChanged,
      Entrar com e-mail e senha, criar usuário com e-mail e senha,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      Provedor de autenticação do Google,
      reautenticarComPopup, reautenticarComRedirecionamento,
      sair
    } de "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    importar {
      getFirestore, coleção, documento,
      adicionarDoc, excluirDoc,
      onSnapshot, consulta, ordenarPor
    } de "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIKbBCn96YbinrRHkDcpvZ4OY7j9Z_ES8",
      authDomain: "gastos-pessoais-a716a.firebaseapp.com",
      projectId: "gastos-pessoais-a716a",
      storageBucket: "gastos-pessoais-a716a.firebasestorage.app",
      messagingSenderId: "928424495392",
      appId: "1:928424495392:web:2d32deb9960d765ab8af45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Estado
    let userUid = null;
    seja gastos = [];
    seja ganhos = [];
    seja unsub = nulo;
    seja unsubGanhos = nulo;
    desbloqueado = falso;

    // Chaves de armazenamento
    const PIN_HASH_KEY = "pinHash_v1";
    const PENDING_PIN_RESET = "pendingPinReset_v1";

    // Referências da interface do usuário
    const syncStatus = document.getElementById("syncStatus");
    const btnLogout = document.getElementById("btnLogout");
    const btnChangePin = document.getElementById("btnChangePin");
    const loginOverlay = document.getElementById("loginOverlay");
    const pinOverlay = document.getElementById("pinOverlay");
    const authMsg = document.getElementById("authMsg");
    const pinMsg = document.getElementById("pinMsg");

    // Valores padrão
    document.getElementById("data").value = new Date().toISOString().slice(0,10);
    document.getElementById("dataGanho").value = new Date().toISOString().slice(0,10);

    function setStatus(t){ syncStatus.textContent = t; }
    function show(el, on){ el.classList.toggle("show", !!on); }

    // Abas
    const tabs = [...document.querySelectorAll(".tab")];
    const cards = [...document.querySelectorAll(".card")];
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      cards.forEach(c => c.classList.toggle("active", c.id === id));
      if (id === "lista") renderLista();
      if (id === "relatório") renderRelatório();
      if (id === "ganhos") renderGanhos();
    }));

    // Ajudantes
    const moeda = (v)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(v)||0);
    const anoMes = (d)=> (d && d.length>=7) ? d.slice(0,7) : "";
    const dataBR = (d)=> new Date(String(d)+"T00:00:00").toLocaleDateString("pt-BR");
    const esc = (s)=> String(s??"").replaceAll("&","&").replaceAll("<","<").replaceAll(">",">").replaceAll('"',""").replaceAll("'","'");
    function soma(arr){ return arr.reduce((t,g)=>t+(Number(g.valor)||0),0); }

    // número robusto
    função parseBRL(v){
      const s = String(v||"").trim().replace(/\s+/g,"");
      if(!s) return 0;
      const norm = s.replace(/\./g,"").replace(",",".");
      const n = parseFloat(norm);
      retornar Number.isFinite(n) ? n : 0;
    }

    função assíncrona sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      retornar [...novo Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    função pinMode(modo){
      document.getElementById("pinSet").style.display = (mode==="set") ? "block" : "none";
      document.getElementById("pinEnter").style.display = (mode==="enter") ? "block" : "none";
      pinMsg.textContent = "";
      document.getElementById("pinNovo").value = "";
      document.getElementById("pinNovo2").value = "";
      document.getElementById("pinDigitado").value = "";
    }

    função assíncrona requirePin(){
      const has = !!localStorage.getItem(PIN_HASH_KEY);
      mostrar(pinOverlay, verdadeiro);
      pinMode(has ? "enter" : "set");
    }

    função unlockUI(){
      mostrar(loginOverlay,falso);
      mostrar(pinOverlay,falso);
      btnLogout.style.display = "inline";
      btnChangePin.style.display = "inline";
      setStatus("Sincronização: ativa");
      atualizarSeleções();
      renderizarLista();
      renderRelatório();
      renderGanhos();
    }

    // Conjunto de PIN
    document.getElementById("btnSalvarPin").addEventListener("click", async ()=>{
      const p1 = (document.getElementById("pinNovo").value||"").trim();
      const p2 = (document.getElementById("pinNovo2").value||"").trim();
      if(!/^\d{4,8}$/.test(p1)){ pinMsg.textContent="PIN precisa ter 4 a 8 dígitos."; return; }
      if(p1!==p2){ pinMsg.textContent="Os PINs não conferem."; retornar; }
      localStorage.setItem(PIN_HASH_KEY, await sha256Hex(p1));
      desbloqueado = verdadeiro;
      se(userUid) desbloquearUI();
      senão mostrar(pinOverlay,falso);
    });

    // Digite o PIN
    document.getElementById("btnDesbloquear").addEventListener("click", async ()=>{
      const pin = (document.getElementById("pinDigitado").value||"").trim();
      const hash = localStorage.getItem(PIN_HASH_KEY);
      if(!hash){ pinMsg.textContent="Nenhum PIN definido. Crie um PIN."; pinMode("configurar"); retornar; }
      if(!/^\d{4,8}$/.test(pin)){ pinMsg.textContent="PIN inválido."; return; }
      if((await sha256Hex(pin))!==hash){ pinMsg.textContent="PIN incorreto."; return; }
      desbloqueado = verdadeiro;
      se(userUid) desbloquearUI();
      senão mostrar(pinOverlay,falso);
    });

    // Limpar PIN local
    document.getElementById("btnLimparPin").addEventListener("click", async ()=>{
      if(!confirm("Remover o PIN salvo neste navegador? Você precisa criar um novo PIN.")) return;
      localStorage.removeItem(PIN_HASH_KEY);
      desbloqueado = falso;
      pinMode("definido");
      pinMsg.textContent = "PIN removido. Crie um novo PIN.";
    });

    // Pino de troca
    btnChangePin.addEventListener("click", async ()=>{
      const hash = localStorage.getItem(PIN_HASH_KEY);
      if(!hash){ alert("Nenhum PIN definido."); await requirePin(); return; }

      const atual = prompt("Dígito ou PIN atual:");
      se (real === nulo) retorne;
      const a = String(atual).trim();
      if(!/^\d{4,8}$/.test(a)){ alert("PIN inválido."); return; }
      if((await sha256Hex(a))!==hash){ alert("PIN atual incorreto."); retornar; }

      const n1 = prompt("Novo PIN (4 a 8 dígitos):");
      se (n1 === nulo) retorne;
      const b = String(n1).trim();
      if(!/^\d{4,8}$/.test(b)){ alert("Novo PIN inválido."); return; }

      const n2 = prompt("Repita o novo PIN:");
      se (n2 === nulo) retorne;
      const c = String(n2).trim();
      if(b!==c){ alert("Os PINs não conferem."); retornar; }

      localStorage.setItem(PIN_HASH_KEY, await sha256Hex(b));
      alert("PIN alterado com sucesso neste navegador.");
    });

    // Esqueci o PIN
    document.getElementById("btnEsqueciPin").addEventListener("click", async ()=>{
      pinMsg.textContent = "";
      if(!confirm("Para redefinir o PIN, confirme sua conta Google. Continuar?")) return;

      const user = auth.currentUser;
      if(!user){ pinMsg.textContent="Você não está logado."; retornar; }

      const provider = new GoogleAuthProvider();

      tentar{
        tentar{
          aguardar reautenticarComPopup(usuário, provedor);
          localStorage.removeItem(PIN_HASH_KEY);
          desbloqueado = falso;
          pinMode("definido");
          pinMsg.textContent = "PIN removido. Crie um novo PIN.";
        } pegar {
          sessionStorage.setItem(PENDING_PIN_RESET, "1");
          aguardar reautenticarComRedirecionamento(usuário, provedor);
        }
      } catch (e){
        console.error(e);
        pinMsg.textContent = "Não foi possível confirmar sua conta Google.";
      }
    });

    // Interface de login
    document.getElementById("btnToggleEmail").addEventListener("click", ()=>{
      const box = document.getElementById("emailBox");
      box.style.display = (box.style.display==="none") ? "block" : "none";
    });

    função authError(e){
      authMsg.textContent = (e && e.message) ? e.message : "Erro ao autenticar.";
    }

    document.getElementById("btnEntrar").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (document.getElementById("authEmail").value||"").trim();
      const pass = (document.getElementById("authPass").value||"").trim();
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnCriar").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (document.getElementById("authEmail").value||"").trim();
      const pass = (document.getElementById("authPass").value||"").trim();
      try{ await createUserWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnGoogle").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const provider = new GoogleAuthProvider();
      tentar{
        aguardar signInWithPopup(auth, provedor);
      } catch (e){
        tente { aguarde signInWithRedirect(auth, provider); }
        catch(e2){ authError(e2); }
      }
    });

    btnLogout.addEventListener("click", async ()=>{
      if(!confirm("Sair e bloquear este navegador?")) return;
      desbloqueado = falso;
      if(unsub){ unsub(); unsub=nulo; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }
      aguardar signOut(auth);
      btnLogout.style.display = "nenhum";
      btnChangePin.style.display = "nenhum";
      setStatus("Sincronização: desconectada");
      mostrar(loginOverlay,true);
      mostrar(pinOverlay,falso);
    });

    // Firestore
    function expensesCol(){ return collection(db, `users/${userUid}/expenses`); }
    function incomeCol(){ return collection(db, `users/${userUid}/income`); }

    função iniciarSincronização(){
      Se (!userUid) retornar;

      if(unsub){ unsub(); unsub=nulo; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }

      setStatus("Sincronização: preparando...");

      const q1 = query(expensesCol(), orderBy("data","desc"));
      unsub = onSnapshot(q1, (snap)=>{
        gastos = snap.docs.map(d=>({id:d.id, ...d.data()}));
        se(desbloqueado) {
          setStatus("Sincronização: ativa");
          atualizarSeleções();
          renderizarLista();
          renderRelatório();
          renderGanhos();
        }
      }, (erro)=>{
        console.error(err);
        setStatus("Sincronização: erro");
      });

      const q2 = query(incomeCol(), orderBy("data","desc"));
      unsubGanhos = onSnapshot(q2, (snap)=>{
        ganhos = snap.docs.map(d=>({id:d.id, ...d.data()}));
        se(desbloqueado) {
          setStatus("Sincronização: ativa");
          atualizarSeleções();
          renderRelatório();
          renderGanhos();
        }
      }, (erro)=>{
        console.error(err);
        setStatus("Sincronização: erro");
      });
    }

    // CRUD - GASTOS
    document.getElementById("btnSalvar").addEventListener("click", async ()=>{
      if(!userUid){ alert("Faça login para salvar."); retornar; }
      if(!unlocked){ alert("Desbloqueio com PIN."); retornar; }

      const data = document.getElementById("data").value;
      const categoria = document.getElementById("categoria").value;
      const descrição = (document.getElementById("descricao").value||"").trim();
      const forma = (document.getElementById("forma").value||"").trim();
      const valor = parseBRL(document.getElementById("valor").valor);

      if(!categoria || valor<=0){ alert("Categoria e valor são obrigatórios."); retornar; }

      await addDoc(expensesCol(), { dados, categoria, descrição, forma, valor, anoMes: anoMes(dados) });

      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("forma").value = "";
    });

    função assíncrona del(id){
      if(!confirm("Excluir este gasto?")) return;
      await deleteDoc(doc(db, `users/${userUid}/expenses/${id}`));
    }
    janela.__del = del;

    // ADICIONAR GANHO
    janela.__adicionarGanho = função assíncrona(){
      tentar{
        if(!userUid){ alert("Faça login para salvar."); retornar; }
        if(!unlocked){ alert("Desbloqueio com PIN."); retornar; }

        const data = document.getElementById("dataGanho").value;
        const tipo = document.getElementById("tipoGanho").value;
        const descrição = (document.getElementById("descGanho").value||"").trim();
        const valor = parseBRL(document.getElementById("valorGanho").valor);

        se(!tipo || valor<=0){
          alert("Tipo e valor são obrigatórios (valor maior que 0).");
          retornar;
        }

        await addDoc(incomeCol(), { data, tipo, descrição, valor, anoMes: anoMes(data) });

        const m = anoMes(dados);
        const sel = document.getElementById("ganhosMes");
        se(sel) sel.valor = m;

        document.getElementById("descGanho").value = "";
        document.getElementById("valorGanho").value = "";
        document.getElementById("tipoGanho").value = "";
      } catch(e){
        console.error(e);
        alert("Erro ao salvar ganho. Abra o console (F12) para ver detalhes.");
      }
    }

    // Excluir ganho
    função assíncrona delGanho(id){
      if(!confirm("Excluir este ganho?")) return;
      await deleteDoc(doc(db, `users/${userUid}/income/${id}`));
    }
    janela.__delGanho = delGanho;

    // Seleciona + filtros
    const filtroMes = document.getElementById("filtroMes");
    const FiltroCat = document.getElementById("filtroCat");
    const relMes = document.getElementById("relatorioMes");
    const ganhosMes = document.getElementById("ganhosMes");

    filtroMes.addEventListener("change", renderList);
    filtroCat.addEventListener("change", renderLista);
    relMes.addEventListener("change", renderRelatorio);
    ganhosMes.addEventListener("alterar", renderGanhos);

    função refreshSelects(){
      const mesesGastos = gastos.map(g=>g.anoMes).filter(Boolean);
      const mesesGanhos = ganhos.map(g=>g.anoMes).filter(Boolean);
      const meses = [...new Set([...mesesGastos, ...mesesGanhos])].sort().reverse();

      const cats = [...new Set(gastos.map(g=>g.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"pt-BR"));

      const keepFM = filtroMes.value;
      const keepFC = FiltroCat.value;
      const keepRM = relMes.value;

      filtroMes.innerHTML = `<option value="">Todos os meses</option>` + meses.map(m=>`<option value="${m}">${m}</option>`).join("");
      relMes.innerHTML = `<option value="">Selecione um mÃªs</option>` + meses.map(m=>`<option value="${m}">${m}</option>`).join("");
      filtroCat.innerHTML = `<option value="">Todas categorias</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

      filtroMes.value = meses.includes(keepFM) ? keepFM : "";
      filtroCat.value = cats.includes(keepFC) ? keepFC : "";
      relMes.value = meses.includes(keepRM) ? keepRM : "";

      const mesesSomenteGanhos = [...new Set(mesesGanhos)].sort().reverse();
      const keepGM = ganhosMes.valor;

      ganhosMes.innerHTML =
        `<option value="">Todos os meses</option>` +
        mesesSomenteGanhos.map(m=>`<option value="${m}">${m}</option>`).join("");

      ganhosMes.value = mesesSomenteGanhos.includes(keepGM) ? keepGM : (mesesSomenteGanhos[0] || "");
    }

    // Lista render (gastos)
    função renderizarLista(){
      const el = document.getElementById("listaGastos");
      const empty = document.getElementById("emptyLista");
      const sumBox = document.getElementById("sumLista");
      const totalEl = document.getElementById("totalLista");

      const m = filtroMes.valor;
      const c = FiltroCat.value;

      const vis = gastos.filter(g => (!m || g.anoMes===m) && (!c || g.categoria===c))
                        .sort((a,b)=>String(b.data).localeCompare(String(a.data)));

      se(!vis.length){
        el.innerHTML = "";
        empty.style.display = "bloco";
        sumBox.style.display = "nenhum";
        retornar;
      }

      empty.style.display = "nenhum";
      sumBox.style.display = "bloco";
      totalEl.textContent = moeda(soma(vis));

      el.innerHTML = vis.map(g=>`
        <div class="item">
          <div class="it-left">
            <div class="it-title">${esc(g.descricao || g.categoria || "")}</div>
            <div class="it-sub">${dataBR(g.data)} â€¢ ${esc(g.categoria||"")} ${g.forma?("â€¢ "+esc(g.forma)):""}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="it-val">${moeda(g.valor)}</div>
            <button class="danger" style="width:auto;padding:8px 10px;margin:0" onclick="__del('${g.id}')">ðŸ—'ï¸ </button>
          </div>
        </div>
      `).join("");
    }

    // Lista render (ganhos)
    função renderGanhos(){
      const box = document.getElementById("listaGanhos");
      const empty = document.getElementById("emptyGanhos");
      const sumBox = document.getElementById("sumGanhosLista");
      const totalEl = document.getElementById("totalGanhosLista");
      if(!box || !empty) return;

      const mes = ganhosMes.valor || "";

      const vis = ganhos
        .filter(g => (!mes || g.anoMes === mes))
        .fatiar()
        .sort((a,b)=>String(b.data).localeCompare(String(a.data)));

      se(!vis.length){
        box.innerHTML = "";
        empty.style.display = "bloco";
        if(sumBox) sumBox.style.display = "none";
        retornar;
      }

      empty.style.display = "nenhum";

      se(sumBox && totalEl){
        sumBox.style.display = "bloco";
        totalEl.textContent = moeda(soma(vis));
      }

      box.innerHTML = vis.map(g=>`
        <div class="item">
          <div class="it-left">
            <div class="it-title">${esc(g.descricao || g.tipo || "")}</div>
            <div class="it-sub">${dataBR(g.data)} • ${esc(g.tipo||"")}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="it-val">${moeda(g.valor)}</div>
            <button class="danger" style="width:auto;padding:8px 10px;margin:0" onclick="__delGanho('${g.id}')">ðŸ—'ï¸ </button>
          </div>
        </div>
      `).join("");
    }

    // Renderização Relatório
    função renderRelatório(){
      const mes = relMes.value;
      const sumRel = document.getElementById("sumRel");
      const totalRel = document.getElementById("totalRel");
      const detalhe = document.getElementById("detalheCategorias");
      const empty = document.getElementById("emptyRel");
      const info = document.getElementById("infoRel");
      const exportBtns = document.getElementById("exportBtns");

      const sumGanhos = document.getElementById("sumGanhos");
      const totalGanhosEl = document.getElementById("totalGanhos");
      const sumSaldo = document.getElementById("sumSaldo");
      const saldoEl = document.getElementById("saldoMes");

      se(!mes){
        sumRel.style.display = "nenhum";
        detalhe.style.display = "nenhum";
        exportBtns.style.display = "nenhum";
        info.style.display = "nenhum";
        empty.style.display = "bloco";

        sumGanhos.style.display = "nenhum";
        sumSaldo.style.display = "nenhum";
        retornar;
      }

      const arr = gastos.filter(g=>g.anoMes===mes);
      const total = soma(arr);
      totalRel.textContent = moeda(total);
      sumRel.style.display = "bloco";
      empty.style.display = "nenhum";

      const arrGanhos = ganhos.filter(g=>g.anoMes===mes);
      const totalGanhos = soma(arrGanhos);
      totalGanhosEl.textContent = moeda(totalGanhos);
      sumGanhos.style.display = "bloco";

      const saldo = totalGanhos - total;
      saldoEl.textContent = moeda(saldo);
      sumSaldo.style.display = "bloco";

      se(!total && !totalGanhos){
        detalhe.style.display = "nenhum";
        exportBtns.style.display = "nenhum";
        info.style.display = "nenhum";
        retornar;
      }

      exportBtns.style.display = "flex";
      info.textContent = `Mês: ${mes} â€¢ Gastos: ${arr.length} â€¢ Ganhos: ${arrGanhos.length}`;
      info.style.display = "bloco";

      se(!total){
        detalhe.style.display = "nenhum";
        retornar;
      }

      const map = {};
      para(const g de arr){
        const gato = g.categoria || “Outros”;
        const v = Number(g.valor)||0;
        if(!map[cat]) map[cat] = {cat,total:0,itens:[],qtd:0,min:v,max:v};
        mapa[gato].total += v;
        map[cat].qtd += 1;
        map[cat].min = Math.min(map[cat].min, v);
        map[cat].max = Math.max(map[cat].max, v);
        map[cat].itens.push({
          dados: g.dados || "",
          desc: (g.descricao && String(g.descricao).trim()) ? String(g.descricao).trim() : "(sem descrição)",
          forma: g.forma || "",
          valor: v
        });
      }

      const cats = Object.values(map).sort((a,b)=>b.total-a.total);
      gatos.paraCada(c=>{
        c.itens.sort((a,b)=>String(b.data).localeCompare(String(a.data)) || (b.valor-a.valor));
      });

      detalhe.innerHTML = cats.map(c=>{
        const pct = total ? (c.total/total*100) : 0;
        const media = c.qtd ? (c.total/c.qtd) : 0;

        const itens = c.itens.map(it=>`
          <div class="cat-item">
            <div class="left">
              <div class="desc">${esc(it.desc)}</div>
              <div class="sub">${dataBR(it.data)}${it.forma?(" • "+esc(it.forma)):""}</div>
            </div>
            <div class="val">${moeda(it.valor)}</div>
          </div>
        `).join("");

        retornar `
          <detalhes>
            <summary>
              <div>
                <div class="cat-name">${esc(c.cat)}</div>
                <div class="cat-meta">Qtd: ${c.qtd} â€¢ MÃ©dia: ${moeda(media)} â€¢ Menor: ${moeda(c.min)} â€¢ Maior: ${moeda(c.max)}</div>
              </div>
              <div>
                <div class="cat-total">${moeda(c.total)}</div>
                <div class="cat-pct">${pct.toFixed(1)}%</div>
              </div>
            </summary>
            <div class="cat-items">${itens}</div>
          </details>
        `;
      }).juntar("");

      detalhe.style.display = "bloco";
    }

    // ===== GERAR PDF DETALHADO (CORRIGIDO) =====
    document.getElementById("btnPdf").addEventListener("click", async ()=>{
      const mes = relMes.value;
      if(!mes){ alert("Selecione um mais."); retornar; }

      const arrGastos = gastos.filter(g=>g.anoMes===mes).sort((a,b)=>String(a.data).localeCompare(String(b.data)));
      const arrGanhos = ganhos.filter(g=>g.anoMes===mes).sort((a,b)=>String(a.data).localeCompare(String(b.data)));

      const totalGastos = soma(arrGastos);
      const totalGanhos = soma(arrGanhos);
      const saldo = totalGanhos - totalGastos;

      // Mapa de categorias
      const map = {};
      para (const g de arrGastos){
        const gato = g.categoria || “Outros”;
        const v = Number(g.valor)||0;
        if(!map[cat]) map[cat] = {cat,total:0,itens:[],qtd:0,min:v,max:v};
        mapa[gato].total += v;
        map[cat].qtd += 1;
        map[cat].min = Math.min(map[cat].min, v);
        map[cat].max = Math.max(map[cat].max, v);
        map[cat].itens.push({
          dados: g.dados || "",
          desc: (g.descricao && String(g.descricao).trim()) ? String(g.descricao).trim() : "(sem descrição)",
          forma: g.forma || "",
          valor: v
        });
      }

      const cats = Object.values(map).sort((a,b)=>b.total-a.total);
      gatos.paraCada(c=>{
        c.itens.sort((a,b)=>String(b.data).localeCompare(String(a.data)));
      });

      // HTML do relatório
      let html = `
        <style>
          * { margem: 0; preenchimento: 0; }
          corpo { família de fontes: Arial, sans-serif; cor: #333; altura da linha: 1,6; }
          .pdf-page { preenchimento: 20px; fundo: branco; }
          h1 { alinhamento de texto: centro; cor: #1a1a1a; borda inferior: 3px sólida #007AFF; preenchimento inferior: 10px; margem inferior: 20px; tamanho da fonte: 28px; }
          h2 { color: #007AFF; border-left: 4px solid #007AFF; padding-left: 10px; margin-top: 25px; margin-bottom: 15px; font-size: 18px; }
          .header-info { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-around; text-align: center; }
          .info-box { flex: 1; }
          .info-label { font-size: 11px; color: #666; text-transform: uppercase; font-weight: bold; }
          .info-value { tamanho da fonte: 18px; peso da fonte: negrito; cor: #007AFF; margem superior: 5px; }
          .info-value.danger { color: #FF3B30; }
          .info-value.success { color: #34C759; }
          tabela { largura: 100%; recolhimento da borda: recolhimento; margem: 15px 0; tamanho da fonte: 12px; }
          th { background: #007AFF; color: white; padding: 10px; text-align: left; font-weight: bold; }
          td { padding: 8px 10px; border-bottom: 1px solid #ddd; }
          tr:nth-child(even) { background: #f9f9f9; }
          .total-row { background: #e3f2fd; font-weight: bold; }
          .category-section { margin-top: 20px; break-inside: avoid; }
          .category-header { background: #f0f0f0; padding: 10px 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; font-size: 13px; }
          .nome-do-gato { peso-da-fonte: negrito; cor: #1a1a1a; }
          .cat-stats { tamanho da fonte: 11px; cor: #666; }
          .cat-total { font-weight: bold; color: #007AFF; }
          .cat-pct { tamanho da fonte: 11px; cor: #999; }
          .item-row { padding: 8px 15px; background: white; border-left: 3px solid #ddd; margin-bottom: 5px; display: flex; justify-content: space-between; font-size: 12px; }
          .item-desc { flex: 1; }
          .item-date { tamanho da fonte: 11px; cor: #999; margem superior: 2px; }
          .item-val { font-weight: bold; color: #333; white-space: nowrap; }
          .summary-grid { display: flex; gap: 15px; margin: 25px 0; }
          .summary-card { flex: 1; background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
          .summary-title { font-size: 11px; color: #666; text-transform: uppercase; font-weight: bold; margin-bottom: 8px; }
          .summary-value { font-size: 20px; font-weight: bold; color: #007AFF; }
          .summary-value.danger { color: #FF3B30; }
          .summary-value.success { color: #34C759; }
          .footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #e0e0e0; text-align: center; font-size: 11px; color: #999; }
          .logo { alinhamento de texto: centro; margem inferior: 15px; tamanho da fonte: 20px; peso da fonte: negrito; cor: #007AFF; }
        </style>

        <div class="pdf-page">
          <div class="logo">ðŸ'° Relatório de Gastos</div>
          <h1>Extrato Financeiro - ${mes}</h1>

          <div class="header-info">
            <div class="info-box">
              <div class="info-label">Total de Ganhos</div>
              <div class="info-value success">${moeda(totalGanhos)}</div>
            </div>
            <div class="info-box">
              <div class="info-label">Total de Gastos</div>
              <div class="info-value perigo">${moeda(totalGastos)}</div>
            </div>
            <div class="info-box">
              <div class="info-label">Saldo</div>
              <div class="info-value ${saldo >= 0 ? 'success' : 'danger'}">${moeda(saldo)}</div>
            </div>
          </div>

          ${arrGanhos.length > 0 ? `
          <section>
            <h2>ðŸ“¥ ENTRADAS (Ganhos)</h2>
            <table>
              <thead>
                <tr>
                  <th>Dados</th>
                  <th>Tipo</th>
                  <th>Descrição</th>
                  <th style="text-align: right;">Valor</th>
                </tr>
              </thead>
              <tbody>
                ${arrGanhos.map(g=>`
                  <tr>
                    <td>${dataBR(g.data)}</td>
                    <td>${esc(g.tipo)}</td>
                    <td>${esc(g.descricao || "â—")}</td>
                    <td style="text-align: right; font-weight: bold; color: #34C759;">${moeda(g.valor)}</td>
                  </tr>
                `).join("")}
                <tr class="total-row">
                  <td colspan="3" style="text-align: right;">TOTAL DE ENTRADAS:</td>
                  <td style="text-align: right; color: #34C759;">${moeda(totalGanhos)}</td>
                </tr>
              </tbody>
            </table>
          </section>
          ` : ""}

          <section>
            <h2>ðŸ“¤ SAÃ DAS (Gastos)</h2>
            <table>
              <thead>
                <tr>
                  <th>Dados</th>
                  <th>Categoria</th>
                  <th>Descrição</th>
                  <th>Pagamento</th>
                  <th style="text-align: right;">Valor</th>
                </tr>
              </thead>
              <tbody>
                ${arrGastos.map(g=>`
                  <tr>
                    <td>${dataBR(g.data)}</td>
                    <td>${esc(g.categoria)}</td>
                    <td>${esc(g.descricao || "â—")}</td>
                    <td>${esc(g.forma || "â—")}</td>
                    <td style="text-align: right; font-weight: bold; color: #FF3B30;">${moeda(g.valor)}</td>
                  </tr>
                `).join("")}
                <tr class="total-row">
                  <td colspan="4" style="text-align: right;">TOTAL SAÍDAS:</td>
                  <td style="text-align: right; color: #FF3B30;">${moeda(totalGastos)}</td>
                </tr>
              </tbody>
            </table>
          </section>

          <section>
            <h2>ðŸ“Š ANÃ LISE POR CATEGORIA</h2>
            ${cats.map(c=>{
              const pct = totalGastos ? (c.total/totalGastos*100) : 0;
              const media = c.qtd ? (c.total/c.qtd) : 0;
              retornar `
                <div class="category-section">
                  <div class="category-header">
                    <div>
                      <div class="cat-name">${esc(c.cat)}</div>
                      <div class="cat-stats">Transações: ${c.qtd} | Mídia: ${moeda(media)} | Mínimo: ${moeda(c.min)} | Máx.: ${moeda(c.max)}</div>
                    </div>
                    <div>
                      <div class="cat-total">${moeda(c.total)}</div>
                      <div class="cat-pct">${pct.toFixed(1)}% do total</div>
                    </div>
                  </div>
                  ${c.itens.map(it=>`
                    <div class="item-row">
                      <div class="item-desc">
                        <div>${esc(it.desc)}</div>
                        <div class="item-date">${dataBR(it.data)}${it.forma ? ` • ${esc(it.forma)}` : ""}</div>
                      </div>
                      <div class="item-val">${moeda(it.valor)}</div>
                    </div>
                  `).join("")}
                </div>
              `;
            }).juntar("")}
          </section>

          <div class="summary-grid">
            <div class="summary-card">
              <div class="summary-title">ðŸ'µ Total de Ganhos</div>
              <div class="summary-value success">${moeda(totalGanhos)}</div>
            </div>
            <div class="summary-card">
              <div class="summary-title">ðŸ'¸ Total de Gastos</div>
              <div class="summary-value danger">${moeda(totalGastos)}</div>
            </div>
            <div class="summary-card">
              <div class="summary-title">ðŸ“ˆ Saldo</div>
              <div class="summary-value ${saldo >= 0 ? 'success' : 'danger'}">${moeda(saldo)}</div>
            </div>
          </div>

          <div class="footer">
            <p>Relatório gerado em ${new Date().toLocaleDateString("pt-BR")} em ${new Date().toLocaleTimeString("pt-BR")}</p>
            <p>Sistema de Controle de Gastos Pessoais</p>
          </div>
        </div>
      `;

      // Cria elemento temporário
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = html;
      document.body.appendChild(tempDiv);

      // Aguardar um pouco para garantir a renderização
      await new Promise(resolve => setTimeout(resolve, 100));

      // Gerar PDF
      const opt ​​= {
        margem: [5, 5, 5, 5],
        nome do arquivo: `Relatório_${mes}.pdf`,
        imagem: { tipo: 'jpeg', qualidade: 0,98 },
        html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      tentar {
        await html2pdf().set(opt).from(tempDiv).save();
      } catch (e) {
        console.error("Erro ao gerar PDF:", e);
        alert("Erro ao gerar PDF. Abra o console (F12) para detalhes.");
      }

      // Remove elemento temporário
      document.body.removeChild(tempDiv);
    });

    // Autenticação
    função assíncrona init(){
      mostrar(loginOverlay, verdadeiro);
      setStatus("Sincronização: desconectada");

      tente {await getRedirectResult(auth); } pegar (_) {}

      if(sessionStorage.getItem(PENDING_PIN_RESET)==="1"){
        sessionStorage.removeItem(PENDING_PIN_RESET);
        localStorage.removeItem(PIN_HASH_KEY);
        desbloqueado = falso;
        mostrar(pinOverlay,verdadeiro);
        pinMode("definido");
      }

      onAuthStateChanged(auth, async (user)=>{
        se(!usuário){
          userUid = nulo;
          desbloqueado = falso;
          if(unsub){ unsub(); unsub=nulo; }
          if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }
          btnLogout.style.display = "nenhum";
          btnChangePin.style.display = "nenhum";
          setStatus("Sincronização: desconectada");
          mostrar(loginOverlay,true);
          retornar;
        }

        userUid = user.uid;
        mostrar(loginOverlay,falso);
        iniciarSincronização();
        aguarde requirePin();
      });
    }

    init();
  </script>
</body>
</html>
