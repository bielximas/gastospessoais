<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gastos</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:linear-gradient(135deg,#667eea,#764ba2);
      min-height:100vh;
      padding:16px;
      padding-bottom:84px; /* espaço para a barra fixa */
    }
    .container{max-width:760px;margin:0 auto}

    /* TOP BRAND */
    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin:10px 0 14px;
    }
    .brand img{
      height:42px;
      width:auto;
      border-radius:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .brand h1{
      color:#fff;
      text-align:center;
      margin:0;
      font-size:34px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .status{display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:12px;margin-bottom:10px}
    .pill{background:#eef2ff;color:#273c75;font-weight:800;border-radius:999px;padding:6px 10px;display:inline-block}
    .status a{color:#fff;text-decoration:underline;cursor:pointer;margin-left:10px}

    /* Tabs */
    .tabs{display:flex;background:#000;border-radius:14px;overflow:hidden;margin-bottom:12px;border:1px solid rgba(255,255,255,.15)}
    .tab{flex:1;border:0;background:#000;color:#fff;padding:12px;font-weight:900;cursor:pointer}
    .tab.active{background:#007AFF;color:#fff}

    .card{background:rgba(255,255,255,.95);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);display:none}
    .card.active{display:block}
    label{display:block;font-weight:800;margin:12px 0 8px;color:#222}
    input,select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#007AFF}
    button{width:100%;border:0;background:#007AFF;color:#fff;padding:12px 14px;border-radius:12px;font-weight:900;font-size:16px;cursor:pointer;margin-top:12px}
    button.secondary{background:#2c2c2e}
    button.danger{background:#FF3B30}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .summary{background:#f2f2f7;border-radius:14px;padding:14px;text-align:center;margin:12px 0}
    .total{font-size:26px;font-weight:900;color:#FF3B30}
    .empty{color:#666;text-align:center;padding:26px 10px}

    .item{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .it-left{min-width:0;flex:1}
    .it-title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .it-sub{font-size:12px;color:#666;margin-top:4px}
    .it-val{font-weight:900;white-space:nowrap}
    .filters{display:flex;gap:10px;margin-bottom:12px}
    .filters select{flex:1}
    .export{display:flex;gap:10px;margin-top:12px}
    .export button{margin-top:0;flex:1;padding:10px}

    /* Relatório detalhado */
    .cats{margin-top:12px;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .cats details{border-bottom:1px solid #eee}
    .cats details:last-child{border-bottom:none}
    .cats summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cats summary::-webkit-details-marker{display:none}
    .cat-name{font-weight:900;color:#111}
    .cat-meta{font-size:12px;color:#666;margin-top:3px}
    .cat-total{font-weight:900;color:#111;text-align:right}
    .cat-pct{font-size:12px;color:#666;text-align:right}
    .cat-items{padding:0 14px 12px}
    .cat-item{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-top:1px dashed #eee;font-size:13px}
    .cat-item .desc{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
    .cat-item .sub{font-size:12px;color:#666;margin-top:2px}
    .cat-item .val{font-weight:900;white-space:nowrap}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .overlay.show{display:flex}
    .modal{width:100%;max-width:560px;background:rgba(255,255,255,.98);border-radius:18px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .modal h2{font-size:18px;margin-bottom:10px;color:#111}
    .note{font-size:12px;color:#555;margin-top:8px;line-height:1.35}
    .msg{font-size:12px;color:#c0392b;font-weight:900;margin-top:8px;min-height:16px}

    /* BARRA FIXA (rodapé) */
    .promoBar{
      position:fixed;
      left:0; right:0; bottom:0;
      z-index:9998;
      padding:12px 14px;
      background:rgba(0,0,0,.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      color:#fff;
      border-top:1px solid rgba(255,255,255,.15);
      text-align:center;
      font-weight:800;
      font-size:13px;
      line-height:1.25;
    }
    .promoBar a{
      color:#fff;
      text-decoration:underline;
      font-weight:900;
      white-space:nowrap;
    }

    @media print{
      body{background:#fff;padding:0}
      .tabs,.status,.overlay,.export,.promoBar{display:none!important}
      .card{box-shadow:none}
      .card{display:block}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="status">
      <div><span class="pill" id="syncStatus">Sincronização: desconectada</span></div>
      <div>
        <a id="btnChangePin" style="display:none">Trocar PIN</a>
        <a id="btnLogout" style="display:none">Sair</a>
      </div>
    </div>

    <!-- TÍTULO COM LOGO -->
    <div class="brand">
      <img alt="Logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAKACAYAAADqyMAiAAAACXBIWXMAAC4jAAAuIwF4pT92AAAgAElEQVR4nOydB5wUxfLHR9/lBHfHcXdkEATJKip/QTGhqKionAkVxawPEXN4iOHpE8xZzOGZs2AOiDkg5oyiomJCBBHlqcx/fr1TS+3czOykvdudre/n05+Du92Znu6erurqqmpNEwRBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEARBEAQhbqzRQkUQBEEQhAzChe6aRvmHWQosZc1WqNuaZuH1oPqtyYooDYIgCIJggQS7nXAPJDR1XVdCuWfPnsWjR48u23jjjSurq6vbGL9ra5TqqqqqmsbGxnYNDQ11PXr0aN+9e/d6/MT/8XvjMzX4LL5j/L4Nvj906NBS43eFTU1N/zCuH1SYr6E5KwqiIAiCIAixw7p6p5JW6M2ePbsAQrimpqZjp06d+tfW1m5m/HsXQ4gfapQp5eXl0woLCy8z/n13RUXFM2VlZS+XlJS8seaaa775j3/846Pi4uKvjf//aHxmyRprrLHUuOQyFOPfv7KynP/f/MxS4/tLi4qKfja+/53x8wvjmu8WFBS8YdzjFeP/Txj/vs+45y3GtS9q06bN2UZdjjbqtl9lZeX2Xbp0GWbUuxeUi969e1fiOTy2k+82EgRBEIRsgIQYmeVdTfMjR44sN1bdXerq6ga3a9dutCHIDzcE6XRDcP/XEKyPQ+Aa5Uuj/GEIZ92uGJdp9WJXL0OBWGU8w1Kj7gsMheENozyG5zKUhulQYIzn3bZt27YDO3bs2AmWijTtSgoUWQ9EMRAEQRBaBdrXJqHkKJAOPvjgMkPA9zSE3QhjpXwAVu3GqvpuQzi+ZAjHT42C1XaKMNXsBe0qs/xtlL+M8qdR/meWP83f/WX+nZdVERR+vb9Y+ZPd/092/1UOz5BSjGdfZZQlxvN/bLTHi6Wlpbcb7XO6oSCMq66uHta1a9duU6dOLXLpB/JBIKVAFANBEAQhMrgTHgmbZmBvvEePHl0MIb+Fsco9pKys7FJj1TvbEG6fGWUZF/I2xSpc7QSqJ6GaRcVOYeHP9ZfbM8GCYJQlhoLwsaEwPQbLSGVl5b7t27cfusEGG9S69Be3wIhCIAiCIPiCm5ybCZG77rrrH2uvvXZ3Q9iPMQT9KcbK9U5jBfvhmmuuCUG/ymEVb10957Jwj1JJsLMsUNukfB7tarTxX0Yb/4RtBaPdbzIUg2Nqamq26tu3b4ODg6LVSiAIgiAISbgDWoqQgFe9IezhNT/CWIEeW1xcfKshfN4zBNHvDvvwEFxxWMG3duHWA25BSGlHUymAxWCZ0S+vG0rB1UZfHW702QZwQPTT14IgCEL8cRQC8Fivr6/vXl1dvVtJScklhlCZU1BQ8LMp7K1CHAKK9sCzVtA7ORCS8HT7e2vX3abY+UGkWAvouYx+W2gobA/Dr6CmpmZk165d7awEfCwIgiAIMYPv4acIAJjzO3Xq1NMQ+HuWlZVdZQj8ecZq8jdT+HFhjn9zgdMiwp4LanOlq4oh3FSh/5Mgb8n68HrY1aUFlQjqi7+01QpZSt+hHkYdFxcWFj5fUVFxXtu2bUf37t27g81YsR0ngiAIQu7AvfT577SePXvWQQAYK8NzDYE/1xBay20EPq0wfXm2+ylWYUoClYRoFPfAdUpLS/U2bdroxipYb9eunV5fX683NjbqhuKjd+nSRe/YsaP6P36PvxvKkPp8SUlJJALcDAtMURRaQEkgSwFtHaRYCUwLwWKj/58xFIIpyLEwYsSICj5OTChhkSAIgpDF2Jpzscpv3779QOzhG0LtSUMALbYIWFo9pvVOD1LshLxXAW8IKL2qqkoJ6sGDB+tbbLGF3tTUpB9yyCH6iSeeqJ999tn65Zdfrv/3v//VZ86cqc+ZM0d//fXX9XfeeUf/9NNP9S+//FL/+uuv9e+++07//vvv9R9//FH/6aef9J9//llfsmSJ/ssvv6ifixcvVr/H3/E5fH7hwoX6ggUL9A8++EB/44039BdffFF/8skn9XvvvVe/7rrr9AsvvFCfOnWqPnnyZP2AAw5Q9dpyyy31gQMH6g0NDXpZWZmeJvohWazKQVQKkKVY+5krBAhJ/Nqo823GONkfIYg240t8BwRBELIIEvopqzSksK2rq9vamNDPN4ToO4Zg+cuyyqfVoa3HedBCq11uDnf6LP7etm1bvWfPnkpw7rvvvkqoX3zxxfqdd96phPknn3yihPWKFSv0v/76S88F/vzzT3358uX6okWL9Lffflt//PHH9RtuuEEpK0cccYQ+ZswYfciQIcoCUV5e7tqevC1RIrQWWH0JkmPA7MMVxcXFL1RUVJzaoUOHdQ1Fx5rNUPwGBEEQWolmQr9Pnz61CM0rLS29obCwcKFF4NMePu0Ph17l81W9m6CHkOvRo4e++eab64cffrh+0UUX6ffdd5/+2muv6d9++63+999/exauq1atUooAhOz//vc/9ZMKfk8F13QruI61pPsOvz7dE3WgeuD3uI5Xfv/9d2WleOaZZ/..."
      />
      <h1>Vamos organizar?</h1>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="gastos">Gastos</button>
      <button class="tab" data-tab="ganhos">Ganhos</button>
      <button class="tab" data-tab="lista">Lista</button>
      <button class="tab" data-tab="relatorio">Relatório</button>
    </div>

    <!-- GASTOS -->
    <section id="gastos" class="card active">
      <label>Data</label>
      <input type="date" id="data" />

      <label>Categoria</label>
      <select id="categoria">
        <option value="">Selecione...</option>
        <option>Alimentação</option>
        <option>Transporte</option>
        <option>Mercado</option>
        <option>Contas</option>
        <option>Lazer</option>
        <option>Compra na internet</option>
        <option>Jogos</option>
        <option>Outros</option>
      </select>

      <label>Descrição</label>
      <input id="descricao" placeholder="Ex: cerveja, churrasco..." />

      <label>Forma de pagamento</label>
      <select id="forma">
        <option value="">Selecione...</option>
        <option>Pix</option>
        <option>Crédito</option>
        <option>Débito</option>
        <option>Espécie</option>
      </select>

      <label>Valor (R$)</label>
      <input type="text" id="valor" inputmode="decimal" placeholder="0,00" />

      <button id="btnSalvar" type="button">Salvar gasto</button>
    </section>

    <!-- GANHOS -->
    <section id="ganhos" class="card">
      <label>Data</label>
      <input type="date" id="dataGanho" />

      <label>Tipo</label>
      <select id="tipoGanho">
        <option value="">Selecione...</option>
        <option>Salário</option>
        <option>Venda</option>
        <option>Manutenção</option>
        <option>Outros</option>
      </select>

      <label>Descrição</label>
      <input id="descGanho" placeholder="Ex: salário, venda iPhone, manutenção..." />

      <label>Valor (R$)</label>
      <input type="text" id="valorGanho" inputmode="decimal" placeholder="0,00" />

      <button id="btnSalvarGanho" type="button" onclick="addGanho()">Salvar ganho</button>

      <div class="filters" style="margin-top:12px">
        <select id="ganhosMes"><option value="">Todos os meses</option></select>
      </div>

      <div class="summary" id="sumGanhosLista" style="display:none">
        <div>Total de ganhos (mês selecionado)</div>
        <div class="total" id="totalGanhosLista">R$ 0,00</div>
      </div>

      <div style="margin-top:12px" id="listaGanhos"></div>
      <div class="empty" id="emptyGanhos">Nenhum ganho ainda.</div>
    </section>

    <!-- LISTA -->
    <section id="lista" class="card">
      <div class="filters">
        <select id="filtroMes"><option value="">Todos os meses</option></select>
        <select id="filtroCat"><option value="">Todas categorias</option></select>
      </div>

      <div class="summary" id="sumLista" style="display:none">
        <div>Total (selecionado)</div>
        <div class="total" id="totalLista">R$ 0,00</div>
      </div>

      <div id="listaGastos"></div>
      <div class="empty" id="emptyLista">Nenhum gasto ainda.</div>
    </section>

    <!-- RELATÓRIO -->
    <section id="relatorio" class="card">
      <div class="filters">
        <select id="relatorioMes"><option value="">Selecione um mês</option></select>
      </div>

      <div class="summary" id="sumRel" style="display:none">
        <div>Total do mês (gastos)</div>
        <div class="total" id="totalRel">R$ 0,00</div>
      </div>

      <div class="summary" id="sumGanhos" style="display:none">
        <div>Total de ganhos do mês</div>
        <div class="total" id="totalGanhos">R$ 0,00</div>
      </div>

      <div class="summary" id="sumSaldo" style="display:none">
        <div>Saldo do mês (ganhos - gastos)</div>
        <div class="total" id="saldoMes">R$ 0,00</div>
      </div>

      <div id="detalheCategorias" class="cats" style="display:none"></div>

      <div class="export" id="exportBtns" style="display:none">
        <button id="btnPdf" type="button">Gerar PDF</button>
      </div>

      <div class="empty" id="emptyRel">Selecione um mês para ver o relatório.</div>
      <div class="note" id="infoRel" style="display:none;text-align:center"></div>
    </section>

    <!-- LOGIN -->
    <div class="overlay" id="loginOverlay">
      <div class="modal">
        <h2>Entrar para sincronizar</h2>
        <div class="row">
          <button id="btnGoogle" type="button">Entrar com Google</button>
          <button class="secondary" id="btnToggleEmail" type="button">Email/senha</button>
        </div>

        <div id="emailBox" style="display:none;margin-top:12px">
          <label>Email</label>
          <input id="authEmail" type="email" autocomplete="email" />
          <label>Senha</label>
          <input id="authPass" type="password" autocomplete="current-password" />
          <div class="row">
            <button id="btnEntrar" type="button">Entrar</button>
            <button class="secondary" id="btnCriar" type="button">Criar conta</button>
          </div>
        </div>

        <div class="msg" id="authMsg"></div>
        <div class="note">Depois do login, você cria/digita um PIN para travar este navegador.</div>
      </div>
    </div>

    <!-- PIN -->
    <div class="overlay" id="pinOverlay">
      <div class="modal">
        <h2>PIN deste navegador</h2>

        <div id="pinSet" style="display:none">
          <label>Crie um PIN (4 a 8 dígitos)</label>
          <input id="pinNovo" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234" />
          <label style="margin-top:10px">Repita o PIN</label>
          <input id="pinNovo2" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234" />
          <button id="btnSalvarPin" type="button">Salvar PIN</button>
        </div>

        <div id="pinEnter" style="display:none">
          <label>Digite seu PIN</label>
          <input id="pinDigitado" inputmode="numeric" pattern="[0-9]*" placeholder="" />
          <button id="btnDesbloquear" type="button">Desbloquear</button>

          <div class="row" style="margin-top:10px">
            <button class="danger" id="btnEsqueciPin" type="button">Esqueci o PIN</button>
            <button class="secondary" id="btnLimparPin" type="button">Limpar PIN deste navegador</button>
          </div>
        </div>

        <div class="msg" id="pinMsg"></div>
        <div class="note">Para resetar o PIN, você precisa confirmar sua conta Google.</div>
      </div>
    </div>

  </div><!-- /container -->

  <!-- BARRA FIXA NO FIM -->
  <div class="promoBar">
    Agora que você conseguiu economizar, vamos atualizar esse iphone?&nbsp;
    <a href="https://www.macanamao.com.br" target="_blank" rel="noopener noreferrer">www.macanamao.com.br</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, signInWithRedirect, getRedirectResult, GoogleAuthProvider,
      reauthenticateWithPopup, reauthenticateWithRedirect, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAIKbBCn96YbinrRHkDcpvZ4OY7j9ZES8",
      authDomain: "gastos-pessoais-a716a.firebaseapp.com",
      projectId: "gastos-pessoais-a716a",
      storageBucket: "gastos-pessoais-a716a.firebasestorage.app",
      messagingSenderId: "928424495392",
      appId: "1:928424495392:web:2d32deb9960d765ab8af45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Estado
    let userUid = null;
    let gastos = [];
    let ganhos = [];
    let unsub = null;
    let unsubGanhos = null;
    let unlocked = false;

    // Storage keys
    const PINHASHKEY = "pinHashv1";
    const PENDINGPINRESET = "pendingPinResetv1";

    // UI refs
    const syncStatus = document.getElementById("syncStatus");
    const btnLogout = document.getElementById("btnLogout");
    const btnChangePin = document.getElementById("btnChangePin");
    const loginOverlay = document.getElementById("loginOverlay");
    const pinOverlay = document.getElementById("pinOverlay");
    const authMsg = document.getElementById("authMsg");
    const pinMsg = document.getElementById("pinMsg");

    // Defaults
    document.getElementById("data").value = new Date().toISOString().slice(0,10);
    document.getElementById("dataGanho").value = new Date().toISOString().slice(0,10);

    function setStatus(t){ syncStatus.textContent = t; }
    function show(el, on){ el.classList.toggle("show", !!on); }

    // Tabs
    const tabs = [...document.querySelectorAll(".tab")];
    const cards = [...document.querySelectorAll(".card")];
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      cards.forEach(c => c.classList.toggle("active", c.id === id));
      if(id === "lista") renderLista();
      if(id === "relatorio") renderRelatorio();
      if(id === "ganhos") renderGanhos();
    }));

    // Helpers
    const moeda = v => new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(v||0));
    const anoMes = d => d && d.length >= 7 ? d.slice(0,7) : "";
    const dataBR = d => new Date(String(d)+"T00:00:00").toLocaleDateString("pt-BR");
    const esc = s => String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    const soma = arr => arr.reduce((t,g)=> t + (Number(g.valor)||0), 0);

    function parseBRL(v){
      const s = String(v||"").trim().replace(/\s/g,"");
      if(!s) return 0;
      const norm = s.replace(/\./g,"").replace(",",".");
      const n = parseFloat(norm);
      return Number.isFinite(n) ? n : 0;
    }

    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
    }

    // --- NOVO: label de mês tipo Jan/2026 ---
    function mesLabel(ym){
      // ym: "YYYY-MM"
      if(!ym || ym.length < 7) return ym || "";
      const [y, m] = ym.split("-");
      const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
      const mi = Math.max(1, Math.min(12, Number(m))) - 1;
      return `${meses[mi]}/${y}`;
    }

    function pinMode(mode){
      document.getElementById("pinSet").style.display = mode === "set" ? "block" : "none";
      document.getElementById("pinEnter").style.display = mode === "enter" ? "block" : "none";
      pinMsg.textContent = "";
      document.getElementById("pinNovo").value = "";
      document.getElementById("pinNovo2").value = "";
      document.getElementById("pinDigitado").value = "";
    }

    async function requirePin(){
      const has = !!localStorage.getItem(PINHASHKEY);
      show(pinOverlay, true);
      pinMode(has ? "enter" : "set");
    }

    function unlockUI(){
      show(loginOverlay,false);
      show(pinOverlay,false);
      btnLogout.style.display = "inline";
      btnChangePin.style.display = "inline";
      setStatus("Sincronização: ativa");
      refreshSelects();
      renderLista();
      renderRelatorio();
      renderGanhos();
    }

    // PIN set
    document.getElementById("btnSalvarPin").addEventListener("click", async () => {
      const p1 = document.getElementById("pinNovo").value.trim();
      const p2 = document.getElementById("pinNovo2").value.trim();
      if(!/^\d{4,8}$/.test(p1)){ pinMsg.textContent="PIN precisa ter 4 a 8 dígitos."; return; }
      if(p1 !== p2){ pinMsg.textContent="Os PINs não conferem."; return; }
      localStorage.setItem(PINHASHKEY, await sha256Hex(p1));
      unlocked = true;
      if(userUid) unlockUI();
      else show(pinOverlay,false);
    });

    // PIN enter
    document.getElementById("btnDesbloquear").addEventListener("click", async () => {
      const pin = document.getElementById("pinDigitado").value.trim();
      const hash = localStorage.getItem(PINHASHKEY);
      if(!hash){ pinMsg.textContent="Nenhum PIN definido. Crie um PIN."; pinMode("set"); return; }
      if(!/^\d{4,8}$/.test(pin)){ pinMsg.textContent="PIN inválido."; return; }
      if(await sha256Hex(pin) !== hash){ pinMsg.textContent="PIN incorreto."; return; }
      unlocked = true;
      if(userUid) unlockUI();
      else show(pinOverlay,false);
    });

    // Limpar PIN local
    document.getElementById("btnLimparPin").addEventListener("click", async () => {
      if(!confirm("Remover o PIN salvo neste navegador? Você precisará criar um novo PIN.")) return;
      localStorage.removeItem(PINHASHKEY);
      unlocked = false;
      pinMode("set");
      pinMsg.textContent = "PIN removido. Crie um novo PIN.";
    });

    // Trocar PIN
    btnChangePin.addEventListener("click", async () => {
      const hash = localStorage.getItem(PINHASHKEY);
      if(!hash){ alert("Nenhum PIN definido."); await requirePin(); return; }
      const atual = prompt("Digite o PIN atual");
      if(atual === null) return;
      const a = String(atual).trim();
      if(!/^\d{4,8}$/.test(a)){ alert("PIN inválido."); return; }
      if(await sha256Hex(a) !== hash){ alert("PIN atual incorreto."); return; }
      const n1 = prompt("Novo PIN (4 a 8 dígitos)");
      if(n1 === null) return;
      const b = String(n1).trim();
      if(!/^\d{4,8}$/.test(b)){ alert("Novo PIN inválido."); return; }
      const n2 = prompt("Repita o novo PIN");
      if(n2 === null) return;
      const c = String(n2).trim();
      if(b !== c){ alert("Os PINs não conferem."); return; }
      localStorage.setItem(PINHASHKEY, await sha256Hex(b));
      alert("PIN alterado com sucesso neste navegador.");
    });

    // Esqueci o PIN
    document.getElementById("btnEsqueciPin").addEventListener("click", async () => {
      pinMsg.textContent = "";
      if(!confirm("Para resetar o PIN, confirme sua conta Google. Continuar?")) return;

      const user = auth.currentUser;
      if(!user){ pinMsg.textContent="Você não está logado."; return; }

      const provider = new GoogleAuthProvider();
      try{
        try{
          await reauthenticateWithPopup(user, provider);
          localStorage.removeItem(PINHASHKEY);
          unlocked = false;
          pinMode("set");
          pinMsg.textContent = "PIN removido. Crie um novo PIN.";
        }catch{
          sessionStorage.setItem(PENDINGPINRESET, "1");
          await reauthenticateWithRedirect(user, provider);
        }
      }catch(e){
        console.error(e);
        pinMsg.textContent = "Não foi possível confirmar sua conta Google.";
      }
    });

    // Login UI
    document.getElementById("btnToggleEmail").addEventListener("click", () => {
      const box = document.getElementById("emailBox");
      box.style.display = (box.style.display === "none" || !box.style.display) ? "block" : "none";
    });
    function authError(e){ authMsg.textContent = (e && e.message) ? e.message : "Erro ao autenticar."; }

    document.getElementById("btnEntrar").addEventListener("click", async () => {
      authMsg.textContent = "";
      const email = document.getElementById("authEmail").value.trim();
      const pass = document.getElementById("authPass").value.trim();
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnCriar").addEventListener("click", async () => {
      authMsg.textContent = "";
      const email = document.getElementById("authEmail").value.trim();
      const pass = document.getElementById("authPass").value.trim();
      try{ await createUserWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnGoogle").addEventListener("click", async () => {
      authMsg.textContent = "";
      const provider = new GoogleAuthProvider();
      try{ await signInWithPopup(auth, provider); }
      catch(e){
        try{ await signInWithRedirect(auth, provider); }
        catch(e2){ authError(e2); }
      }
    });

    btnLogout.addEventListener("click", async () => {
      if(!confirm("Sair e bloquear este navegador?")) return;
      unlocked = false;
      if(unsub){ unsub(); unsub=null; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }
      await signOut(auth);
      btnLogout.style.display = "none";
      btnChangePin.style.display = "none";
      setStatus("Sincronização: desconectada");
      show(loginOverlay,true);
      show(pinOverlay,false);
    });

    // Firestore
    function expensesCol(){ return collection(db, `users/${userUid}/expenses`); }
    function incomeCol(){ return collection(db, `users/${userUid}/income`); }

    function startSync(){
      if(!userUid) return;
      if(unsub){ unsub(); unsub=null; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }

      setStatus("Sincronização: preparando...");

      const q1 = query(expensesCol(), orderBy("data","desc"));
      unsub = onSnapshot(q1, snap => {
        gastos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(unlocked){
          setStatus("Sincronização: ativa");
          refreshSelects();
          renderLista(); renderRelatorio(); renderGanhos();
        }
      }, err => { console.error(err); setStatus("Sincronização: erro"); });

      const q2 = query(incomeCol(), orderBy("data","desc"));
      unsubGanhos = onSnapshot(q2, snap => {
        ganhos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if(unlocked){
          setStatus("Sincronização: ativa");
          refreshSelects();
          renderRelatorio(); renderGanhos();
        }
      }, err => { console.error(err); setStatus("Sincronização: erro"); });
    }

    // CRUD - GASTOS
    document.getElementById("btnSalvar").addEventListener("click", async () => {
      if(!userUid){ alert("Faça login para salvar."); return; }
      if(!unlocked){ alert("Desbloqueie com PIN."); return; }

      const data = document.getElementById("data").value;
      const categoria = document.getElementById("categoria").value;
      const descricao = document.getElementById("descricao").value.trim();
      const forma = document.getElementById("forma").value.trim();
      const valor = parseBRL(document.getElementById("valor").value);

      if(!categoria || valor <= 0){ alert("Categoria e valor são obrigatórios."); return; }

      await addDoc(expensesCol(), { data, categoria, descricao, forma, valor, anoMes: anoMes(data) });

      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("forma").value = "";
    });

    async function del(id){
      if(!confirm("Excluir este gasto?")) return;
      await deleteDoc(doc(db, `users/${userUid}/expenses/${id}`));
    }
    window.del = del;

    // ADD GANHO
    window.addGanho = async function(){
      try{
        if(!userUid){ alert("Faça login para salvar."); return; }
        if(!unlocked){ alert("Desbloqueie com PIN."); return; }

        const data = document.getElementById("dataGanho").value;
        const tipo = document.getElementById("tipoGanho").value;
        const descricao = document.getElementById("descGanho").value.trim();
        const valor = parseBRL(document.getElementById("valorGanho").value);

        if(!tipo || valor <= 0){ alert("Tipo e valor são obrigatórios (valor maior que 0)."); return; }

        await addDoc(incomeCol(), { data, tipo, descricao, valor, anoMes: anoMes(data) });

        const m = anoMes(data);
        const sel = document.getElementById("ganhosMes");
        if(sel) sel.value = m;

        document.getElementById("descGanho").value = "";
        document.getElementById("valorGanho").value = "";
        document.getElementById("tipoGanho").value = "";
      }catch(e){
        console.error(e);
        alert("Erro ao salvar ganho. Abra o console (F12) para ver detalhes.");
      }
    };

    async function delGanho(id){
      if(!confirm("Excluir este ganho?")) return;
      await deleteDoc(doc(db, `users/${userUid}/income/${id}`));
    }
    window.delGanho = delGanho;

    // Selects/filtros
    const filtroMes = document.getElementById("filtroMes");
    const filtroCat = document.getElementById("filtroCat");
    const relMes = document.getElementById("relatorioMes");
    const ganhosMes = document.getElementById("ganhosMes");

    filtroMes.addEventListener("change", renderLista);
    filtroCat.addEventListener("change", renderLista);
    relMes.addEventListener("change", renderRelatorio);
    ganhosMes.addEventListener("change", renderGanhos);

    function refreshSelects(){
      const mesesGastos = gastos.map(g => g.anoMes).filter(Boolean);
      const mesesGanhos = ganhos.map(g => g.anoMes).filter(Boolean);
      const meses = [...new Set([...mesesGastos, ...mesesGanhos])].sort().reverse();

      const cats = [...new Set(gastos.map(g => g.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"pt-BR"));

      const keepFM = filtroMes.value;
      const keepFC = filtroCat.value;
      const keepRM = relMes.value;

      // agora o texto do option é mesLabel(m)
      filtroMes.innerHTML = `<option value="">Todos os meses</option>` +
        meses.map(m => `<option value="${m}">${mesLabel(m)}</option>`).join("");

      relMes.innerHTML = `<option value="">Selecione um mês</option>` +
        meses.map(m => `<option value="${m}">${mesLabel(m)}</option>`).join("");

      filtroCat.innerHTML = `<option value="">Todas categorias</option>` +
        cats.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");

      filtroMes.value = meses.includes(keepFM) ? keepFM : "";
      filtroCat.value = cats.includes(keepFC) ? keepFC : "";
      relMes.value = meses.includes(keepRM) ? keepRM : "";

      const mesesSomenteGanhos = [...new Set(mesesGanhos)].sort().reverse();
      const keepGM = ganhosMes.value;

      ganhosMes.innerHTML = `<option value="">Todos os meses</option>` +
        mesesSomenteGanhos.map(m => `<option value="${m}">${mesLabel(m)}</option>`).join("");

      ganhosMes.value = mesesSomenteGanhos.includes(keepGM) ? keepGM : (mesesSomenteGanhos[0] || "");
    }

    // Lista render gastos
    function renderLista(){
      const el = document.getElementById("listaGastos");
      const empty = document.getElementById("emptyLista");
      const sumBox = document.getElementById("sumLista");
      const totalEl = document.getElementById("totalLista");

      const m = filtroMes.value;
     
