<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gastos - Assistente Pessoal</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { color: white; text-align: center; margin-bottom: 16px; font-size: 24px; }
    .tabs { display: flex; background: rgba(255,255,255,0.95); border-radius: 15px; margin-bottom: 20px; overflow: hidden; }
    .tab { flex: 1; padding: 15px; background: none; border: none; font-size: 16px; cursor: pointer; transition: all 0.3s; }
    .tab.active { background: #007AFF; color: white; }
    .tab-content { background: rgba(255,255,255,0.95); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; }
    .tab-content.active { display: block; }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 8px; font-weight: 800; color: #333; }
    input, select { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; }
    input:focus, select:focus { outline: none; border-color: #007AFF; }
    button { background: #007AFF; color: white; border: none; padding: 15px 18px; border-radius: 10px; font-size: 16px; font-weight: 900; cursor: pointer; width: 100%; margin-top: 10px; transition: background 0.3s; }
    button:hover { background: #0056cc; }
    button.secondary { background: #2c2c2e; }
    button.secondary:hover { background: #111; }
    button.danger { background: #FF3B30; }
    button.danger:hover { background: #D32F2F; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .list-info { flex: 1; }
    .list-date { font-size: 14px; color: #666; }
    .list-amount { font-size: 18px; font-weight: 900; color: #333; }
    .summary { background: #F2F2F7; padding: 18px; border-radius: 15px; text-align: center; margin: 16px 0; }
    .total-amount { font-size: 28px; font-weight: 900; color: #FF3B30; }
    .filter-group { display: flex; gap: 10px; margin-bottom: 16px; }
    .filter-group select { flex: 1; }
    .empty-state { text-align: center; color: #666; padding: 34px 16px; }
    .export-btns { display: flex; gap: 10px; margin-top: 16px; }
    .export-btns button { flex: 1; padding: 12px; margin-top: 0; }
    canvas { display: block; margin: 16px auto; border-radius: 20px; }
    @media print { body { background: white; } .tab-content:not(.active) { display: none !important; } }

    .legend { background: #fff; border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    .legend-item { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #eee; }
    .legend-item:last-child { border-bottom: none; }
    .legend-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .swatch { width: 12px; height: 12px; border-radius: 4px; flex: 0 0 12px; }
    .legend-title { font-weight: 900; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .legend-sub { font-size: 12px; color: #666; }
    .legend-right { text-align: right; }
    .legend-value { font-weight: 900; color: #333; }
    .legend-pct { font-size: 12px; color: #666; }

    .table-wrap { margin-top: 14px; overflow: auto; border-radius: 14px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    table.report { width: 100%; border-collapse: collapse; font-size: 14px; }
    table.report th, table.report td { padding: 10px 12px; border-bottom: 1px solid #eee; white-space: nowrap; }
    table.report th { background: #f6f7fb; font-weight: 900; color: #333; text-align: left; }
    table.report td:last-child, table.report th:last-child { text-align: right; }

    .small-muted { font-size: 12px; color: #666; margin-top: 10px; text-align: center; }

    .statusbar { display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; color:#fff; font-size: 12px; }
    .pill { display:inline-block; font-size: 12px; padding: 6px 10px; border-radius: 999px; background:#eef2ff; color:#273c75; font-weight: 900; }
    .statusbar a { color:#fff; text-decoration: underline; cursor:pointer; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 9999; }
    .overlay.show { display: flex; }
    .card { width: 100%; max-width: 520px; background: rgba(255,255,255,0.98); border-radius: 18px; padding: 18px; box-shadow: 0 12px 30px rgba(0,0,0,0.25); }
    .card h2 { font-size: 18px; margin-bottom: 10px; color: #111; }
    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .note { font-size: 12px; color: #555; margin-top: 8px; line-height: 1.35; }
    .top-actions { display: flex; gap: 10px; margin-top: 10px; }
    .top-actions button { flex: 1; margin-top: 0; }
  </style>
</head>

<body>
  <div class="container">
    <div class="statusbar">
      <div><span class="pill" id="syncStatus">Sincroniza√ß√£o: conectando...</span></div>
      <div><a id="btnLogout" style="display:none;">Sair</a></div>
    </div>

    <h1>Gastos</h1>

    <div class="tabs">
      <button class="tab active" onclick="showTab('novo', event)">Novo gasto</button>
      <button class="tab" onclick="showTab('lista', event)">Meus gastos</button>
      <button class="tab" onclick="showTab('relatorio', event)">Relat√≥rio</button>
    </div>

    <div id="novo" class="tab-content active">
      <div class="form-group">
        <label>Data</label>
        <input type="date" id="data" />
      </div>
      <div class="form-group">
        <label>Categoria</label>
        <select id="categoria">
          <option value="">Selecione...</option>
          <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
          <option value="Transporte">Transporte</option>
          <option value="Mercado">Mercado</option>
          <option value="Contas">Contas</option>
          <option value="Lazer">Lazer</option>
          <option value="Compra na internet">Compra na internet</option>
          <option value="Jogos">Jogos</option>
          <option value="Outros">Outros</option>
        </select>
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input type="text" id="descricao" placeholder="Ex: Caf√©, Uber, etc." />
      </div>
      <div class="form-group">
        <label>Forma de pagamento</label>
        <select id="forma">
          <option value="">Selecione...</option>
          <option value="Pix">Pix</option>
          <option value="Cr√©dito">Cr√©dito</option>
          <option value="D√©bito">D√©bito</option>
          <option value="Esp√©cie">Esp√©cie</option>
        </select>
      </div>
      <div class="form-group">
        <label>Valor (R$)</label>
        <input type="number" id="valor" step="0.01" placeholder="0.00" />
      </div>
      <button onclick="salvarGasto()">Salvar</button>
    </div>

    <div id="lista" class="tab-content">
      <div class="filter-group">
        <select id="filtroMes" onchange="filtrarGastos()">
          <option value="">Todos os meses</option>
        </select>
        <select id="filtroCat" onchange="filtrarGastos()">
          <option value="">Todas categorias</option>
        </select>
      </div>

      <div id="summaryLista" class="summary" style="display:none;">
        <div>Total selecionado</div>
        <div id="totalLista" class="total-amount">R$ 0,00</div>
      </div>

      <div id="listaGastos"></div>

      <div id="emptyLista" class="empty-state">
        <div>Nenhum gasto ainda</div>
        <div>V√° em "Novo gasto" para come√ßar.</div>
      </div>
    </div>

    <div id="relatorio" class="tab-content">
      <div class="filter-group">
        <select id="relatorioMes" onchange="gerarRelatorio()">
          <option value="">Selecione um m√™s</option>
        </select>
      </div>

      <div id="summaryRelatorio" class="summary" style="display:none;">
        <div>Total do m√™s</div>
        <div id="totalRelatorio" class="total-amount">R$ 0,00</div>
      </div>

      <canvas id="graficoCategorias" width="320" height="320" style="display:none;"></canvas>
      <div id="legendaCategorias" class="legend" style="display:none;"></div>
      <div id="tabelaCategorias" class="table-wrap" style="display:none;"></div>

      <div class="export-btns" id="exportBtns" style="display:none;">
        <button onclick="exportarCSV()">CSV (Excel)</button>
        <button onclick="imprimirRelatorio()">PDF</button>
      </div>

      <div id="emptyRelatorio" class="empty-state">
        <div>Selecione um m√™s para relat√≥rio</div>
      </div>

      <div class="small-muted" id="infoRelatorio" style="display:none;"></div>
    </div>
  </div>

  <!-- Login -->
  <div class="overlay" id="loginOverlay">
    <div class="card">
      <h2>Entrar para sincronizar</h2>

      <div class="top-actions">
        <button id="btnGoogle">Entrar com Google</button>
        <button class="secondary" id="btnMostrarEmail">Email/senha</button>
      </div>

      <div id="emailBox" style="display:none; margin-top:12px;">
        <div class="form-group">
          <label>Email</label>
          <input id="authEmail" type="email" placeholder="seuemail@exemplo.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label>Senha</label>
          <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <div class="top-actions">
          <button id="btnEntrar">Entrar</button>
          <button class="secondary" id="btnCriarConta">Criar conta</button>
        </div>
      </div>

      <div class="note" id="authMsg" style="color:#c0392b; font-weight:900;"></div>
      <div class="note">Ap√≥s entrar, voc√™ cria/digita um PIN para travar este aparelho. Os gastos ficam na nuvem.</div>
    </div>
  </div>

  <!-- PIN -->
  <div class="overlay" id="pinOverlay">
    <div class="card">
      <h2>PIN deste aparelho</h2>

      <div class="form-group" id="pinSetGroup" style="display:none;">
        <label>Crie um PIN (4 a 8 d√≠gitos)</label>
        <input id="pinNovo" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <label style="margin-top:10px;">Repita o PIN</label>
        <input id="pinNovo2" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <button id="btnSalvarPin">Salvar PIN</button>
      </div>

      <div class="form-group" id="pinEnterGroup" style="display:none;">
        <label>Digite seu PIN</label>
        <input id="pinDigitado" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button id="btnDesbloquear">Desbloquear</button>
      </div>

      <div class="top-actions" style="margin-top:12px;">
        <button class="secondary" id="btnTrocarPin">Trocar PIN</button>
        <button class="danger" id="btnLimparPin">Esqueci o PIN (limpar)</button>
      </div>

      <div class="note" id="pinMsg" style="color:#c0392b; font-weight:900;"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      GoogleAuthProvider,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      doc,
      addDoc,
      deleteDoc,
      onSnapshot,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Seu config
    const firebaseConfig = {
      apiKey: "AIzaSyAIKbBCn96YbinrRHkDcpvZ4OY7j9Z_ES8",
      authDomain: "gastos-pessoais-a716a.firebaseapp.com",
      projectId: "gastos-pessoais-a716a",
      storageBucket: "gastos-pessoais-a716a.firebasestorage.app",
      messagingSenderId: "928424495392",
      appId: "1:928424495392:web:2d32deb9960d765ab8af45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let gastos = [];
    let userUid = null;
    let unsub = null;
    let appUnlocked = false;

    const PALETA = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#2ecc71','#e74c3c','#3498db','#9b59b6'];

    const syncStatus = document.getElementById('syncStatus');
    const btnLogout = document.getElementById('btnLogout');
    const authMsg = document.getElementById('authMsg');

    const PIN_HASH_KEY = 'pinHash_v1';

    function setStatus(t) { syncStatus.textContent = t; }

    function showOverlay(id, show) {
      document.getElementById(id).classList.toggle('show', !!show);
    }

    document.getElementById('data').value = new Date().toISOString().split('T')[0];

    // Navega√ß√£o
    window.showTab = function(nome, ev) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(nome).classList.add('active');
      if (ev && ev.target) ev.target.classList.add('active');
      if (nome === 'lista') atualizarLista();
      if (nome === 'relatorio') gerarRelatorio();
    };

    // PIN (hash SHA-256)
    async function sha256Hex(str) {
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function pinUiMode(mode) {
      document.getElementById('pinSetGroup').style.display = (mode === 'set') ? 'block' : 'none';
      document.getElementById('pinEnterGroup').style.display = (mode === 'enter') ? 'block' : 'none';
      document.getElementById('pinMsg').textContent = '';
      document.getElementById('pinNovo').value = '';
      document.getElementById('pinNovo2').value = '';
      document.getElementById('pinDigitado').value = '';
    }

    async function requirePinUnlock() {
      const hash = localStorage.getItem(PIN_HASH_KEY);
      showOverlay('pinOverlay', true);
      pinUiMode(hash ? 'enter' : 'set');
    }

    async function unlockIfReady() {
      if (userUid && appUnlocked) {
        showOverlay('loginOverlay', false);
        showOverlay('pinOverlay', false);
        btnLogout.style.display = 'inline';
        setStatus('Sincroniza√ß√£o: ativa');
        atualizarTudo();
      }
    }

    document.getElementById('btnSalvarPin').addEventListener('click', async () => {
      const p1 = (document.getElementById('pinNovo').value || '').trim();
      const p2 = (document.getElementById('pinNovo2').value || '').trim();
      const msg = document.getElementById('pinMsg');
      if (!/^\d{4,8}$/.test(p1)) { msg.textContent = 'PIN precisa ter 4 a 8 d√≠gitos.'; return; }
      if (p1 !== p2) { msg.textContent = 'Os PINs n√£o conferem.'; return; }
      localStorage.setItem(PIN_HASH_KEY, await sha256Hex(p1));
      appUnlocked = true;
      await unlockIfReady();
    });

    document.getElementById('btnDesbloquear').addEventListener('click', async () => {
      const pin = (document.getElementById('pinDigitado').value || '').trim();
      const msg = document.getElementById('pinMsg');
      const hash = localStorage.getItem(PIN_HASH_KEY);
      if (!/^\d{4,8}$/.test(pin)) { msg.textContent = 'PIN inv√°lido.'; return; }
      if ((await sha256Hex(pin)) !== hash) { msg.textContent = 'PIN incorreto.'; return; }
      appUnlocked = true;
      await unlockIfReady();
    });

    document.getElementById('btnTrocarPin').addEventListener('click', () => pinUiMode('set'));
    document.getElementById('btnLimparPin').addEventListener('click', () => {
      if (!confirm('Remover o PIN deste aparelho?')) return;
      localStorage.removeItem(PIN_HASH_KEY);
      appUnlocked = false;
      pinUiMode('set');
    });

    // Login UI
    document.getElementById('btnMostrarEmail').addEventListener('click', () => {
      const box = document.getElementById('emailBox');
      box.style.display = (box.style.display === 'none') ? 'block' : 'none';
    });

    function showAuthError(e) {
      authMsg.textContent = (e && e.message) ? e.message : 'Erro ao autenticar.';
    }

    document.getElementById('btnEntrar').addEventListener('click', async () => {
      authMsg.textContent = '';
      const email = (document.getElementById('authEmail').value || '').trim();
      const pass = (document.getElementById('authPass').value || '').trim();
      try { await signInWithEmailAndPassword(auth, email, pass); }
      catch (e) { showAuthError(e); }
    });

    document.getElementById('btnCriarConta').addEventListener('click', async () => {
      authMsg.textContent = '';
      const email = (document.getElementById('authEmail').value || '').trim();
      const pass = (document.getElementById('authPass').value || '').trim();
      try { await createUserWithEmailAndPassword(auth, email, pass); }
      catch (e) { showAuthError(e); }
    });

    document.getElementById('btnGoogle').addEventListener('click', async () => {
      authMsg.textContent = '';
      try {
        const provider = new GoogleAuthProvider();
        // Tenta popup primeiro
        await signInWithPopup(auth, provider);
      } catch (e) {
        // Se popup bloquear, vai de redirect (mais est√°vel no mobile) [web:218][web:216]
        try {
          const provider = new GoogleAuthProvider();
          await signInWithRedirect(auth, provider);
        } catch (e2) {
          showAuthError(e2);
        }
      }
    });

    btnLogout.addEventListener('click', async () => {
      if (!confirm('Sair e bloquear o app neste aparelho?')) return;
      appUnlocked = false;
      if (unsub) { unsub(); unsub = null; }
      await signOut(auth);
      btnLogout.style.display = 'none';
      setStatus('Sincroniza√ß√£o: desconectada');
      showOverlay('loginOverlay', true);
    });

    // Firestore refs
    function expensesColRef() {
      return collection(db, `users/${userUid}/expenses`);
    }

    function startRealtimeSync() {
      if (!userUid) return;
      if (unsub) { unsub(); unsub = null; }
      const q = query(expensesColRef(), orderBy('data', 'desc'));
      unsub = onSnapshot(q, (snap) => {
        gastos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        if (appUnlocked) atualizarTudo();
      }, (err) => {
        console.error(err);
        setStatus('Sincroniza√ß√£o: erro');
      });
    }

    // Estado Auth (inclui retorno do redirect)
    async function initAuthFlow() {
      try { await getRedirectResult(auth); } catch (_) {}
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          userUid = null;
          if (unsub) { unsub(); unsub = null; }
          setStatus('Sincroniza√ß√£o: desconectada');
          showOverlay('loginOverlay', true);
          return;
        }
        userUid = user.uid;
        setStatus('Sincroniza√ß√£o: preparando...');
        showOverlay('loginOverlay', false);
        startRealtimeSync();
        await requirePinUnlock();
        await unlockIfReady();
      });
    }

    // CRUD
    window.salvarGasto = async function() {
      if (!userUid) { alert('Fa√ßa login para salvar.'); return; }
      if (!appUnlocked) { alert('Desbloqueie com PIN.'); return; }

      const data = document.getElementById('data').value;
      const novoGasto = {
        data,
        categoria: document.getElementById('categoria').value,
        descricao: document.getElementById('descricao').value,
        forma: document.getElementById('forma').value,
        valor: parseFloat(document.getElementById('valor').value) || 0,
        anoMes: formatarAnoMes(data)
      };

      if (!novoGasto.categoria || novoGasto.valor <= 0) {
        alert('Categoria e valor s√£o obrigat√≥rios.');
        return;
      }

      await addDoc(expensesColRef(), novoGasto);

      document.getElementById('descricao').value = '';
      document.getElementById('valor').value = '';
      document.getElementById('forma').value = '';
    };

    window.excluirGasto = async function(id) {
      if (!userUid) return;
      if (!appUnlocked) { alert('Desbloqueie com PIN.'); return; }
      if (!confirm('Excluir este gasto?')) return;
      await deleteDoc(doc(db, `users/${userUid}/expenses/${id}`));
    };

    // Lista + Relat√≥rio
    function atualizarLista() {
      const listaEl = document.getElementById('listaGastos');
      const emptyEl = document.getElementById('emptyLista');
      const summaryEl = document.getElementById('summaryLista');

      const filtroMes = document.getElementById('filtroMes').value;
      const filtroCat = document.getElementById('filtroCat').value;

      const visiveis = gastos.filter(g => {
        const mesOk = !filtroMes || g.anoMes === filtroMes;
        const catOk = !filtroCat || g.categoria === filtroCat;
        return mesOk && catOk;
      }).sort((a,b) => new Date(b.data) - new Date(a.data));

      if (visiveis.length === 0) {
        listaEl.innerHTML = '';
        emptyEl.style.display = 'block';
        summaryEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      summaryEl.style.display = 'block';
      document.getElementById('totalLista').textContent = formatarMoeda(somaGastos(visiveis));

      listaEl.innerHTML = visiveis.map(g => `
        <div class="list-item">
          <div class="list-info">
            <div style="font-weight: 900;">${escapeHtml(g.descricao || g.categoria)}</div>
            <div class="list-date">${formatarData(g.data)} ‚Ä¢ ${escapeHtml(g.categoria)} ‚Ä¢ ${escapeHtml(g.forma || '')}</div>
          </div>
          <div style="display:flex; gap:10px;">
            <div class="list-amount">${formatarMoeda(Number(g.valor)||0)}</div>
            <button class="danger" onclick="excluirGasto('${g.id}')" style="width:auto; padding:8px 12px;">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    window.filtrarGastos = () => atualizarLista();

    function gerarRelatorio() {
      const mesSelecionado = document.getElementById('relatorioMes').value;
      const canvas = document.getElementById('graficoCategorias');
      const summary = document.getElementById('summaryRelatorio');
      const exportBtns = document.getElementById('exportBtns');
      const empty = document.getElementById('emptyRelatorio');
      const legenda = document.getElementById('legendaCategorias');
      const tabela = document.getElementById('tabelaCategorias');
      const info = document.getElementById('infoRelatorio');

      if (!mesSelecionado) {
        canvas.style.display = 'none';
        summary.style.display = 'none';
        exportBtns.style.display = 'none';
        legenda.style.display = 'none';
        tabela.style.display = 'none';
        info.style.display = 'none';
        empty.style.display = 'block';
        return;
      }

      const gastosMes = gastos.filter(g => g.anoMes === mesSelecionado);
      const totalMes = somaGastos(gastosMes);

      document.getElementById('totalRelatorio').textContent = formatarMoeda(totalMes);
      summary.style.display = 'block';
      empty.style.display = 'none';

      if (totalMes > 0) {
        exportBtns.style.display = 'flex';
        desenharGrafico(gastosMes);
       function montarResumoCategorias(gastosMes, totalMes) {
  const legenda = document.getElementById('legendaCategorias');
  const tabela = document.getElementById('tabelaCategorias');

  const porCat = {};
  const stats = {};
  const itensPorCat = {};

  gastosMes.forEach(g => {
    const cat = g.categoria || 'Outros';
    const v = Number(g.valor) || 0;

    porCat[cat] = (porCat[cat] || 0) + v;

    if (!stats[cat]) stats[cat] = { qtd: 0, max: v, min: v, total: 0 };
    stats[cat].qtd += 1;
    stats[cat].total += v;
    stats[cat].max = Math.max(stats[cat].max, v);
    stats[cat].min = Math.min(stats[cat].min, v);

    if (!itensPorCat[cat]) itensPorCat[cat] = [];
    itensPorCat[cat].push({
      desc: (g.descricao && String(g.descricao).trim()) ? String(g.descricao).trim() : '(sem descri√ß√£o)',
      valor: v,
      data: g.data || ''
    });
  });

  // Ordena categorias por total (desc)
  const entries = Object.entries(porCat).sort((a, b) => b[1] - a[1]);

  // Ordena itens dentro da categoria por valor (desc) e depois por data (desc)
  entries.forEach(([cat]) => {
    itensPorCat[cat].sort((a, b) => (b.valor - a.valor) || (String(b.data).localeCompare(String(a.data))));
  });

  // ===== Legenda (cards) com itens abaixo =====
  legenda.innerHTML = entries.map(([cat, val], idx) => {
    const pct = totalMes > 0 ? (val / totalMes) * 100 : 0;
    const cor = PALETA[idx % PALETA.length];
    const qtd = stats[cat].qtd;
    const media = val / qtd;

    const itensHtml = (itensPorCat[cat] || []).map(it => `
      <div class="subitem">
        <div class="name">${escapeHtml(it.desc)}</div>
        <div class="val">${formatarMoeda(it.valor)}</div>
      </div>
    `).join('');

    return `
      <div class="legend-item" style="flex-direction: column; align-items: stretch;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
          <div class="legend-left">
            <span class="swatch" style="background:${cor}"></span>
            <div style="min-width:0">
              <div class="legend-title">${escapeHtml(cat)}</div>
              <div class="legend-sub">Qtd: ${qtd} ‚Ä¢ M√©dia: ${formatarMoeda(media)}</div>
            </div>
          </div>
          <div class="legend-right">
            <div class="legend-value">${formatarMoeda(val)}</div>
            <div class="legend-pct">${pct.toFixed(1)}%</div>
          </div>
        </div>

        <div class="subitems">
          ${itensHtml}
        </div>
      </div>
    `;
  }).join('');
  legenda.style.display = 'block';

  // ===== Tabela com uma ‚Äúlinha detalhe‚Äù logo abaixo =====
  const linhas = entries.map(([cat, val]) => {
    const pct = totalMes > 0 ? (val / totalMes) * 100 : 0;
    const qtd = stats[cat].qtd;
    const media = val / qtd;

    const itensLinha = (itensPorCat[cat] || []).map(it =>
      `${escapeHtml(it.desc)} ‚Äî ${formatarMoeda(it.valor)}`
    ).join('<br>');

    return `
      <tr>
        <td>${escapeHtml(cat)}</td>
        <td>${qtd}</td>
        <td>${formatarMoeda(media)}</td>
        <td>${formatarMoeda(stats[cat].min)}</td>
        <td>${formatarMoeda(stats[cat].max)}</td>
        <td>${pct.toFixed(1)}%</td>
        <td>${formatarMoeda(val)}</td>
      </tr>
      <tr>
        <td colspan="7" style="white-space: normal; color:#333; font-size:12px; padding-top:6px;">
          ${itensLinha || '<span style="color:#666;">(Sem itens)</span>'}
        </td>
      </tr>
    `;
  }).join('');

  tabela.innerHTML = `
    <table class="report">
      <thead>
        <tr>
          <th>Categoria</th><th>Qtd</th><th>M√©dia</th><th>Menor</th><th>Maior</th><th>%</th><th>Total</th>
        </tr>
      </thead>
      <tbody>${linhas}</tbody>
    </table>
  `;
  tabela.style.display = 'block';
}

      } else {
        canvas.style.display = 'none';
        exportBtns.style.display = 'none';
        legenda.style.display = 'none';
        tabela.style.display = 'none';
        info.style.display = 'none';
      }
    }

    window.gerarRelatorio = gerarRelatorio;

    function desenharGrafico(gastosMes) {
      const canvas = document.getElementById('graficoCategorias');
      const ctx = canvas.getContext('2d');
      canvas.width = 320; canvas.height = 320;

      const porCat = {};
      gastosMes.forEach(g => porCat[g.categoria] = (porCat[g.categoria] || 0) + (Number(g.valor)||0));

      const entries = Object.entries(porCat).sort((a,b) => b[1] - a[1]);
      const valores = entries.map(e => e[1]);

      const total = valores.reduce((a,b) => a+b, 0);
      let angulo = -Math.PI/2;
      ctx.clearRect(0,0,320,320);

      valores.forEach((v,i) => {
        const fatia = (v/total) * 2*Math.PI;
        ctx.beginPath();
        ctx.arc(160,160,120,angulo,angulo+fatia);
        ctx.lineTo(160,160);
        ctx.closePath();
        ctx.fillStyle = PALETA[i % PALETA.length];
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        angulo += fatia;
      });

      // percentuais nas fatias maiores
      angulo = -Math.PI/2;
      ctx.fillStyle = '#111';
      ctx.font = '900 12px -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif';

      valores.forEach((v) => {
        const fatia = (v/total) * 2*Math.PI;
        const meio = angulo + fatia/2;
        const pct = Math.round((v/total)*100);
        if (pct >= 6) {
          const x = 160 + Math.cos(meio)*85;
          const y = 160 + Math.sin(meio)*85;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(`${pct}%`, x, y);
        }
        angulo += fatia;
      });

      canvas.style.display = 'block';
    }

    function montarResumoCategorias(gastosMes, totalMes) {
      const legenda = document.getElementById('legendaCategorias');
      const tabela = document.getElementById('tabelaCategorias');

      const porCat = {};
      const stats = {};
      gastosMes.forEach(g => {
        const v = Number(g.valor)||0;
        porCat[g.categoria] = (porCat[g.categoria] || 0) + v;
        if (!stats[g.categoria]) stats[g.categoria] = { qtd:0, max:v, min:v, total:0 };
        stats[g.categoria].qtd += 1;
        stats[g.categoria].total += v;
        stats[g.categoria].max = Math.max(stats[g.categoria].max, v);
        stats[g.categoria].min = Math.min(stats[g.categoria].min, v);
      });

      const entries = Object.entries(porCat).sort((a,b) => b[1] - a[1]);

      legenda.innerHTML = entries.map(([cat,val], idx) => {
        const pct = totalMes > 0 ? (val/totalMes)*100 : 0;
        const cor = PALETA[idx % PALETA.length];
        const qtd = stats[cat].qtd;
        const media = val / qtd;
        return `
          <div class="legend-item">
            <div class="legend-left">
              <span class="swatch" style="background:${cor}"></span>
              <div style="min-width:0">
                <div class="legend-title">${escapeHtml(cat)}</div>
                <div class="legend-sub">Qtd: ${qtd} ‚Ä¢ M√©dia: ${formatarMoeda(media)}</div>
              </div>
            </div>
            <div class="legend-right">
              <div class="legend-value">${formatarMoeda(val)}</div>
              <div class="legend-pct">${pct.toFixed(1)}%</div>
            </div>
          </div>
        `;
      }).join('');
      legenda.style.display = 'block';

      const linhas = entries.map(([cat,val]) => {
        const pct = totalMes > 0 ? (val/totalMes)*100 : 0;
        const qtd = stats[cat].qtd;
        const media = val / qtd;
        return `
          <tr>
            <td>${escapeHtml(cat)}</td>
            <td>${qtd}</td>
            <td>${formatarMoeda(media)}</td>
            <td>${formatarMoeda(stats[cat].min)}</td>
            <td>${formatarMoeda(stats[cat].max)}</td>
            <td>${pct.toFixed(1)}%</td>
            <td>${formatarMoeda(val)}</td>
          </tr>
        `;
      }).join('');

      tabela.innerHTML = `
        <table class="report">
          <thead>
            <tr><th>Categoria</th><th>Qtd</th><th>M√©dia</th><th>Menor</th><th>Maior</th><th>%</th><th>Total</th></tr>
          </thead>
          <tbody>${linhas}</tbody>
        </table>
      `;
      tabela.style.display = 'block';
    }

    window.exportarCSV = function() {
      const mes = document.getElementById('relatorioMes').value;
      const gastosMes = gastos.filter(g => g.anoMes === mes);

      // Excel: BOM UTF-8 + sep=; costuma abrir correto (acentos/colunas). [web:64][web:56]
      const BOM = '\ufeff';
      const SEP = ';';
      const EOL = '\r\n';

      const total = somaGastos(gastosMes);

      const esc = (s) => `"${String(s ?? '').replace(/"/g, '""')}"`;
      const num = (n) => String(Number(n || 0).toFixed(2)).replace('.', ',');

      let csv = BOM + `sep=${SEP}` + EOL;
      csv += `Relat√≥rio${SEP}${esc(formatarMes(mes))}${EOL}${EOL}`;
      csv += `Data${SEP}Categoria${SEP}Descri√ß√£o${SEP}Forma${SEP}Valor${EOL}`;

      gastosMes.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(g => {
        csv += `${esc(formatarData(g.data))}${SEP}${esc(g.categoria)}${SEP}${esc(g.descricao)}${SEP}${esc(g.forma)}${SEP}${num(g.valor)}${EOL}`;
      });

      csv += `${EOL}Total do m√™s${SEP}${SEP}${SEP}${SEP}${num(total)}${EOL}`;

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `Relatorio_${mes}.csv`;
      a.click();
    };

    window.imprimirRelatorio = () => window.print();

    function popularSelects() {
      const mesesUnicos = [...new Set(gastos.map(g => g.anoMes).filter(Boolean))].sort().reverse();
      document.getElementById('filtroMes').innerHTML =
        '<option value="">Todos os meses</option>' + mesesUnicos.map(m => `<option value="${m}">${formatarMes(m)}</option>`).join('');
      document.getElementById('relatorioMes').innerHTML =
        '<option value="">Selecione um m√™s</option>' + mesesUnicos.map(m => `<option value="${m}">${formatarMes(m)}</option>`).join('');

      const cats = [...new Set(gastos.map(g => g.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'pt-BR'));
      document.getElementById('filtroCat').innerHTML =
        '<option value="">Todas categorias</option>' + cats.map(c => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join('');
    }

    function atualizarTudo() {
      popularSelects();
      atualizarLista();
      gerarRelatorio();
    }

    function somaGastos(arr) { return arr.reduce((t,g) => t + (Number(g.valor)||0), 0); }
    function formatarAnoMes(dataStr) { return (dataStr && dataStr.length >= 7) ? dataStr.slice(0,7) : ''; }
    function formatarMes(anoMes) {
      if (!anoMes) return '';
      const meses = ['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const [ano, mes] = anoMes.split('-');
      const idx = Math.max(1, Math.min(12, parseInt(mes,10))) - 1;
      return `${meses[idx]} ${ano}`;
    }
    function formatarData(data) { return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR'); }
    function formatarMoeda(v) { return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v)||0); }
    function escapeHtml(str) {
      return String(str ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }
    function escapeHtmlAttr(str) { return escapeHtml(str); }

    setStatus('Sincroniza√ß√£o: desconectada');
    showOverlay('loginOverlay', true);
    initAuthFlow();
  </script>
</body>
</html>
