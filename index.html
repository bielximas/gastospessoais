<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:16px}
    .container{max-width:760px;margin:0 auto}
    h1{color:#fff;text-align:center;margin:10px 0 14px}
    .status{display:flex;justify-content:space-between;align-items:center;color:#fff;font-size:12px;margin-bottom:10px}
    .pill{background:#eef2ff;color:#273c75;font-weight:800;border-radius:999px;padding:6px 10px;display:inline-block}
    .status a{color:#fff;text-decoration:underline;cursor:pointer;margin-left:10px}
    .tabs{display:flex;background:rgba(255,255,255,.95);border-radius:14px;overflow:hidden;margin-bottom:12px}
    .tab{flex:1;border:0;background:transparent;padding:12px;font-weight:800;cursor:pointer}
    .tab.active{background:#007AFF;color:#fff}
    .card{background:rgba(255,255,255,.95);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.18);display:none}
    .card.active{display:block}
    label{display:block;font-weight:800;margin:12px 0 8px;color:#222}
    input,select{width:100%;padding:12px;border:2px solid #e1e5e9;border-radius:12px;font-size:16px}
    input:focus,select:focus{outline:none;border-color:#007AFF}
    button{width:100%;border:0;background:#007AFF;color:#fff;padding:12px 14px;border-radius:12px;font-weight:900;font-size:16px;cursor:pointer;margin-top:12px}
    button.secondary{background:#2c2c2e}
    button.danger{background:#FF3B30}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .summary{background:#f2f2f7;border-radius:14px;padding:14px;text-align:center;margin:12px 0}
    .total{font-size:26px;font-weight:900;color:#FF3B30}
    .empty{color:#666;text-align:center;padding:26px 10px}
    .item{background:#fff;border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .it-left{min-width:0;flex:1}
    .it-title{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .it-sub{font-size:12px;color:#666;margin-top:4px}
    .it-val{font-weight:900;white-space:nowrap}
    .filters{display:flex;gap:10px;margin-bottom:12px}
    .filters select{flex:1}
    .export{display:flex;gap:10px;margin-top:12px}
    .export button{margin-top:0;flex:1;padding:10px}
    /* Relat√≥rio detalhado */
    .cats{margin-top:12px;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .cats details{border-bottom:1px solid #eee}
    .cats details:last-child{border-bottom:none}
    .cats summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .cats summary::-webkit-details-marker{display:none}
    .cat-name{font-weight:900;color:#111}
    .cat-meta{font-size:12px;color:#666;margin-top:3px}
    .cat-total{font-weight:900;color:#111;text-align:right}
    .cat-pct{font-size:12px;color:#666;text-align:right}
    .cat-items{padding:0 14px 12px}
    .cat-item{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-top:1px dashed #eee;font-size:13px}
    .cat-item .desc{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:420px}
    .cat-item .sub{font-size:12px;color:#666;margin-top:2px}
    .cat-item .val{font-weight:900;white-space:nowrap}
    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .overlay.show{display:flex}
    .modal{width:100%;max-width:560px;background:rgba(255,255,255,.98);border-radius:18px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.25)}
    .modal h2{font-size:18px;margin-bottom:10px;color:#111}
    .note{font-size:12px;color:#555;margin-top:8px;line-height:1.35}
    .msg{font-size:12px;color:#c0392b;font-weight:900;margin-top:8px;min-height:16px}
    @media print{
      body{background:#fff;padding:0}
      .tabs,.status,.overlay,.export{display:none!important}
      .card{box-shadow:none}
      .card{display:block}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="status">
      <div><span class="pill" id="syncStatus">Sincroniza√ß√£o: desconectada</span></div>
      <div>
        <a id="btnChangePin" style="display:none">Trocar PIN</a>
        <a id="btnLogout" style="display:none">Sair</a>
      </div>
    </div>

    <h1>Gastos</h1>

    <div class="tabs">
      <button class="tab active" data-tab="novo">Novo</button>
      <button class="tab" data-tab="ganhos">Ganhos</button>
      <button class="tab" data-tab="lista">Lista</button>
      <button class="tab" data-tab="relatorio">Relat√≥rio</button>
    </div>

    <section id="novo" class="card active">
      <label>Data</label>
      <input type="date" id="data">

      <label>Categoria</label>
      <select id="categoria">
        <option value="">Selecione...</option>
        <option>Alimenta√ß√£o</option>
        <option>Transporte</option>
        <option>Mercado</option>
        <option>Contas</option>
        <option>Lazer</option>
        <option>Compra na internet</option>
        <option>Jogos</option>
        <option>Outros</option>
      </select>

      <label>Descri√ß√£o</label>
      <input id="descricao" placeholder="Ex: cerveja, churrasco...">

      <label>Forma de pagamento</label>
      <select id="forma">
        <option value="">Selecione...</option>
        <option>Pix</option>
        <option>Cr√©dito</option>
        <option>D√©bito</option>
        <option>Esp√©cie</option>
      </select>

      <label>Valor (R$)</label>
      <input type="number" id="valor" step="0.01" placeholder="0,00">

      <button id="btnSalvar">Salvar</button>
    </section>

    <!-- GANHOS -->
    <section id="ganhos" class="card">
      <label>Data</label>
      <input type="date" id="dataGanho">

      <label>Tipo</label>
      <select id="tipoGanho">
        <option value="">Selecione...</option>
        <option>Sal√°rio</option>
        <option>Venda</option>
        <option>Manuten√ß√£o</option>
        <option>Outros</option>
      </select>

      <label>Descri√ß√£o</label>
      <input id="descGanho" placeholder="Ex: sal√°rio, venda iPhone, manuten√ß√£o...">

      <label>Valor (R$)</label>
      <input type="number" id="valorGanho" step="0.01" placeholder="0,00">

      <button id="btnSalvarGanho">Salvar ganho</button>

      <div style="margin-top:12px" id="listaGanhos"></div>
      <div class="empty" id="emptyGanhos">Nenhum ganho ainda.</div>
    </section>

    <section id="lista" class="card">
      <div class="filters">
        <select id="filtroMes"><option value="">Todos os meses</option></select>
        <select id="filtroCat"><option value="">Todas categorias</option></select>
      </div>

      <div class="summary" id="sumLista" style="display:none">
        <div>Total selecionado</div>
        <div class="total" id="totalLista">R$ 0,00</div>
      </div>

      <div id="listaGastos"></div>
      <div class="empty" id="emptyLista">Nenhum gasto ainda.</div>
    </section>

    <section id="relatorio" class="card">
      <div class="filters">
        <select id="relatorioMes"><option value="">Selecione um m√™s</option></select>
      </div>

      <div class="summary" id="sumRel" style="display:none">
        <div>Total do m√™s (gastos)</div>
        <div class="total" id="totalRel">R$ 0,00</div>
      </div>

      <div class="summary" id="sumGanhos" style="display:none">
        <div>Total de ganhos do m√™s</div>
        <div class="total" id="totalGanhos">R$ 0,00</div>
      </div>

      <div class="summary" id="sumSaldo" style="display:none">
        <div>Saldo do m√™s (ganhos - gastos)</div>
        <div class="total" id="saldoMes">R$ 0,00</div>
      </div>

      <div id="detalheCategorias" class="cats" style="display:none"></div>

      <div class="export" id="exportBtns" style="display:none">
        <button id="btnCsv">CSV (Excel)</button>
        <button id="btnPdf">PDF</button>
      </div>

      <div class="empty" id="emptyRel">Selecione um m√™s para ver o relat√≥rio.</div>
      <div class="note" id="infoRel" style="display:none;text-align:center"></div>
    </section>
  </div>

  <!-- LOGIN -->
  <div class="overlay" id="loginOverlay">
    <div class="modal">
      <h2>Entrar para sincronizar</h2>

      <div class="row">
        <button id="btnGoogle">Entrar com Google</button>
        <button class="secondary" id="btnToggleEmail">Email/senha</button>
      </div>

      <div id="emailBox" style="display:none;margin-top:12px">
        <label>Email</label>
        <input id="authEmail" type="email" autocomplete="email">

        <label>Senha</label>
        <input id="authPass" type="password" autocomplete="current-password">

        <div class="row">
          <button id="btnEntrar">Entrar</button>
          <button class="secondary" id="btnCriar">Criar conta</button>
        </div>
      </div>

      <div class="msg" id="authMsg"></div>
      <div class="note">Depois do login, voc√™ cria/digita um PIN para travar este navegador.</div>
    </div>
  </div>

  <!-- PIN -->
  <div class="overlay" id="pinOverlay">
    <div class="modal">
      <h2>PIN deste navegador</h2>

      <div id="pinSet" style="display:none">
        <label>Crie um PIN (4 a 8 d√≠gitos)</label>
        <input id="pinNovo" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <label style="margin-top:10px">Repita o PIN</label>
        <input id="pinNovo2" inputmode="numeric" pattern="[0-9]*" placeholder="Ex: 1234">
        <button id="btnSalvarPin">Salvar PIN</button>
      </div>

      <div id="pinEnter" style="display:none">
        <label>Digite seu PIN</label>
        <input id="pinDigitado" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button id="btnDesbloquear">Desbloquear</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="danger" id="btnEsqueciPin">Esqueci o PIN</button>
        <button class="secondary" id="btnLimparPin">Limpar PIN deste navegador</button>
      </div>

      <div class="msg" id="pinMsg"></div>
      <div class="note">Para resetar o PIN, voc√™ precisa confirmar sua conta Google.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, signInWithRedirect, getRedirectResult,
      GoogleAuthProvider,
      reauthenticateWithPopup, reauthenticateWithRedirect,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, doc,
      addDoc, deleteDoc,
      onSnapshot, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIKbBCn96YbinrRHkDcpvZ4OY7j9Z_ES8",
      authDomain: "gastos-pessoais-a716a.firebaseapp.com",
      projectId: "gastos-pessoais-a716a",
      storageBucket: "gastos-pessoais-a716a.firebasestorage.app",
      messagingSenderId: "928424495392",
      appId: "1:928424495392:web:2d32deb9960d765ab8af45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let userUid = null;
    let gastos = [];
    let ganhos = [];
    let unsub = null;
    let unsubGanhos = null;
    let unlocked = false;

    const PIN_HASH_KEY = "pinHash_v1";
    const PENDING_PIN_RESET = "pendingPinReset_v1";

    const syncStatus = document.getElementById("syncStatus");
    const btnLogout = document.getElementById("btnLogout");
    const btnChangePin = document.getElementById("btnChangePin");
    const loginOverlay = document.getElementById("loginOverlay");
    const pinOverlay = document.getElementById("pinOverlay");
    const authMsg = document.getElementById("authMsg");
    const pinMsg = document.getElementById("pinMsg");

    document.getElementById("data").value = new Date().toISOString().slice(0,10);
    document.getElementById("dataGanho").value = new Date().toISOString().slice(0,10);

    function setStatus(t){ syncStatus.textContent = t; }
    function show(el, on){ el.classList.toggle("show", !!on); }

    const tabs = [...document.querySelectorAll(".tab")];
    const cards = [...document.querySelectorAll(".card")];
    tabs.forEach(t => t.addEventListener("click", () => {
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab;
      cards.forEach(c => c.classList.toggle("active", c.id === id));
      if (id === "lista") renderLista();
      if (id === "relatorio") renderRelatorio();
      if (id === "ganhos") renderGanhos();
    }));

    const moeda = (v)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(v)||0);
    const anoMes = (d)=> (d && d.length>=7) ? d.slice(0,7) : "";
    const dataBR = (d)=> new Date(String(d)+"T00:00:00").toLocaleDateString("pt-BR");
    const esc = (s)=> String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    function soma(arr){ return arr.reduce((t,g)=>t+(Number(g.valor)||0),0); }

    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    function pinMode(mode){
      document.getElementById("pinSet").style.display = (mode==="set") ? "block" : "none";
      document.getElementById("pinEnter").style.display = (mode==="enter") ? "block" : "none";
      pinMsg.textContent = "";
      document.getElementById("pinNovo").value = "";
      document.getElementById("pinNovo2").value = "";
      document.getElementById("pinDigitado").value = "";
    }

    async function requirePin(){
      const has = !!localStorage.getItem(PIN_HASH_KEY);
      show(pinOverlay, true);
      pinMode(has ? "enter" : "set");
    }

    function unlockUI(){
      show(loginOverlay,false);
      show(pinOverlay,false);
      btnLogout.style.display = "inline";
      btnChangePin.style.display = "inline";
      setStatus("Sincroniza√ß√£o: ativa");
      refreshSelects();
      renderLista();
      renderRelatorio();
      renderGanhos();
    }

    // Criar PIN (regex corrigido: /^\d{4,8}$/)
    document.getElementById("btnSalvarPin").addEventListener("click", async ()=>{
      const p1 = (document.getElementById("pinNovo").value||"").trim();
      const p2 = (document.getElementById("pinNovo2").value||"").trim();
      if(!/^\d{4,8}$/.test(p1)){ pinMsg.textContent="PIN precisa ter 4 a 8 d√≠gitos."; return; }
      if(p1!==p2){ pinMsg.textContent="Os PINs n√£o conferem."; return; }

      localStorage.setItem(PIN_HASH_KEY, await sha256Hex(p1));
      unlocked = true;

      if(userUid) unlockUI();
      else show(pinOverlay,false);
    });

    // Entrar com PIN (regex corrigido: /^\d{4,8}$/)
    document.getElementById("btnDesbloquear").addEventListener("click", async ()=>{
      const pin = (document.getElementById("pinDigitado").value||"").trim();
      const hash = localStorage.getItem(PIN_HASH_KEY);

      if(!hash){
        pinMsg.textContent="Nenhum PIN definido. Crie um PIN.";
        pinMode("set");
        return;
      }
      if(!/^\d{4,8}$/.test(pin)){ pinMsg.textContent="PIN inv√°lido."; return; }

      const calc = await sha256Hex(pin);
      if(calc !== hash){ pinMsg.textContent="PIN incorreto."; return; }

      unlocked = true;
      if(userUid) unlockUI();
      else show(pinOverlay,false);
    });

    // Limpar PIN local
    document.getElementById("btnLimparPin").addEventListener("click", async ()=>{
      if(!confirm("Remover o PIN salvo neste navegador? Voc√™ precisar√° criar um novo PIN.")) return;
      localStorage.removeItem(PIN_HASH_KEY);
      unlocked = false;
      pinMode("set");
      pinMsg.textContent = "PIN removido. Crie um novo PIN.";
    });

    // Trocar PIN (regex corrigido: /^\d{4,8}$/)
    btnChangePin.addEventListener("click", async ()=>{
      const hash = localStorage.getItem(PIN_HASH_KEY);
      if(!hash){ alert("Nenhum PIN definido."); await requirePin(); return; }

      const atual = prompt("Digite o PIN atual:");
      if(atual === null) return;
      const a = String(atual).trim();
      if(!/^\d{4,8}$/.test(a)){ alert("PIN inv√°lido."); return; }
      if((await sha256Hex(a))!==hash){ alert("PIN atual incorreto."); return; }

      const n1 = prompt("Novo PIN (4 a 8 d√≠gitos):");
      if(n1 === null) return;
      const b = String(n1).trim();
      if(!/^\d{4,8}$/.test(b)){ alert("Novo PIN inv√°lido."); return; }

      const n2 = prompt("Repita o novo PIN:");
      if(n2 === null) return;
      const c = String(n2).trim();
      if(b!==c){ alert("Os PINs n√£o conferem."); return; }

      localStorage.setItem(PIN_HASH_KEY, await sha256Hex(b));
      alert("PIN alterado com sucesso neste navegador.");
    });

    // Esqueci o PIN (reauth Google)
    document.getElementById("btnEsqueciPin").addEventListener("click", async ()=>{
      pinMsg.textContent = "";
      if(!confirm("Para resetar o PIN, confirme sua conta Google. Continuar?")) return;

      const user = auth.currentUser;
      if(!user){ pinMsg.textContent="Voc√™ n√£o est√° logado."; return; }

      const provider = new GoogleAuthProvider();

      try{
        try{
          await reauthenticateWithPopup(user, provider);
          localStorage.removeItem(PIN_HASH_KEY);
          unlocked = false;
          pinMode("set");
          pinMsg.textContent = "PIN removido. Crie um novo PIN.";
        } catch {
          sessionStorage.setItem(PENDING_PIN_RESET, "1");
          await reauthenticateWithRedirect(user, provider);
        }
      } catch (e){
        console.error(e);
        pinMsg.textContent = "N√£o foi poss√≠vel confirmar sua conta Google.";
      }
    });

    // Login UI
    document.getElementById("btnToggleEmail").addEventListener("click", ()=>{
      const box = document.getElementById("emailBox");
      box.style.display = (box.style.display==="none") ? "block" : "none";
    });

    function authError(e){
      authMsg.textContent = (e && e.message) ? e.message : "Erro ao autenticar.";
    }

    document.getElementById("btnEntrar").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (document.getElementById("authEmail").value||"").trim();
      const pass = (document.getElementById("authPass").value||"").trim();
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnCriar").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const email = (document.getElementById("authEmail").value||"").trim();
      const pass = (document.getElementById("authPass").value||"").trim();
      try{ await createUserWithEmailAndPassword(auth, email, pass); }
      catch(e){ authError(e); }
    });

    document.getElementById("btnGoogle").addEventListener("click", async ()=>{
      authMsg.textContent = "";
      const provider = new GoogleAuthProvider();
      try{
        await signInWithPopup(auth, provider);
      } catch (e){
        try{ await signInWithRedirect(auth, provider); }
        catch(e2){ authError(e2); }
      }
    });

    btnLogout.addEventListener("click", async ()=>{
      if(!confirm("Sair e bloquear este navegador?")) return;
      unlocked = false;
      if(unsub){ unsub(); unsub=null; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }
      await signOut(auth);
      btnLogout.style.display = "none";
      btnChangePin.style.display = "none";
      setStatus("Sincroniza√ß√£o: desconectada");
      show(loginOverlay,true);
      show(pinOverlay,false);
    });

    // Firestore
    function expensesCol(){ return collection(db, `users/${userUid}/expenses`); }
    function incomeCol(){ return collection(db, `users/${userUid}/income`); }

    function startSync(){
      if(!userUid) return;

      if(unsub){ unsub(); unsub=null; }
      if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }

      setStatus("Sincroniza√ß√£o: preparando...");

      const q1 = query(expensesCol(), orderBy("data","desc"));
      unsub = onSnapshot(q1, (snap)=>{
        gastos = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(unlocked) {
          setStatus("Sincroniza√ß√£o: ativa");
          refreshSelects();
          renderLista();
          renderRelatorio();
          renderGanhos();
        }
      }, (err)=>{
        console.error(err);
        setStatus("Sincroniza√ß√£o: erro");
      });

      const q2 = query(incomeCol(), orderBy("data","desc"));
      unsubGanhos = onSnapshot(q2, (snap)=>{
        ganhos = snap.docs.map(d=>({id:d.id, ...d.data()}));
        if(unlocked) {
          setStatus("Sincroniza√ß√£o: ativa");
          refreshSelects();
          renderRelatorio();
          renderGanhos();
        }
      }, (err)=>{
        console.error(err);
        setStatus("Sincroniza√ß√£o: erro");
      });
    }

    // CRUD - GASTOS
    document.getElementById("btnSalvar").addEventListener("click", async ()=>{
      if(!userUid){ alert("Fa√ßa login para salvar."); return; }
      if(!unlocked){ alert("Desbloqueie com PIN."); return; }

      const data = document.getElementById("data").value;
      const categoria = document.getElementById("categoria").value;
      const descricao = (document.getElementById("descricao").value||"").trim();
      const forma = (document.getElementById("forma").value||"").trim();
      const valor = parseFloat(document.getElementById("valor").value) || 0;

      if(!categoria || valor<=0){ alert("Categoria e valor s√£o obrigat√≥rios."); return; }

      await addDoc(expensesCol(), { data, categoria, descricao, forma, valor, anoMes: anoMes(data) });

      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("forma").value = "";
    });

    async function del(id){
      if(!confirm("Excluir este gasto?")) return;
      await deleteDoc(doc(db, `users/${userUid}/expenses/${id}`));
    }
    window.__del = del;

    // CRUD - GANHOS
    document.getElementById("btnSalvarGanho").addEventListener("click", async ()=>{
      if(!userUid){ alert("Fa√ßa login para salvar."); return; }
      if(!unlocked){ alert("Desbloqueie com PIN."); return; }

      const data = document.getElementById("dataGanho").value;
      const tipo = document.getElementById("tipoGanho").value;
      const descricao = (document.getElementById("descGanho").value||"").trim();
      const valor = parseFloat(document.getElementById("valorGanho").value) || 0;

      if(!tipo || valor<=0){ alert("Tipo e valor s√£o obrigat√≥rios."); return; }

      await addDoc(incomeCol(), { data, tipo, descricao, valor, anoMes: anoMes(data) });

      document.getElementById("descGanho").value = "";
      document.getElementById("valorGanho").value = "";
      document.getElementById("tipoGanho").value = "";
    });

    async function delGanho(id){
      if(!confirm("Excluir este ganho?")) return;
      await deleteDoc(doc(db, `users/${userUid}/income/${id}`));
    }
    window.__delGanho = delGanho;

    // Selects + filtros
    const filtroMes = document.getElementById("filtroMes");
    const filtroCat = document.getElementById("filtroCat");
    const relMes = document.getElementById("relatorioMes");

    filtroMes.addEventListener("change", renderLista);
    filtroCat.addEventListener("change", renderLista);
    relMes.addEventListener("change", renderRelatorio);

    function refreshSelects(){
      const mesesGastos = gastos.map(g=>g.anoMes).filter(Boolean);
      const mesesGanhos = ganhos.map(g=>g.anoMes).filter(Boolean);
      const meses = [...new Set([...mesesGastos, ...mesesGanhos])].sort().reverse();

      const cats = [...new Set(gastos.map(g=>g.categoria).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"pt-BR"));

      const keepFM = filtroMes.value;
      const keepFC = filtroCat.value;
      const keepRM = relMes.value;

      filtroMes.innerHTML = `<option value="">Todos os meses</option>` + meses.map(m=>`<option value="${m}">${m}</option>`).join("");
      relMes.innerHTML = `<option value="">Selecione um m√™s</option>` + meses.map(m=>`<option value="${m}">${m}</option>`).join("");
      filtroCat.innerHTML = `<option value="">Todas categorias</option>` + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");

      filtroMes.value = meses.includes(keepFM) ? keepFM : "";
      filtroCat.value = cats.includes(keepFC) ? keepFC : "";
      relMes.value = meses.includes(keepRM) ? keepRM : "";
    }

    // Lista render (gastos)
    function renderLista(){
      const el = document.getElementById("listaGastos");
      const empty = document.getElementById("emptyLista");
      const sumBox = document.getElementById("sumLista");
      const totalEl = document.getElementById("totalLista");

      const m = filtroMes.value;
      const c = filtroCat.value;

      const vis = gastos.filter(g => (!m || g.anoMes===m) && (!c || g.categoria===c))
                        .sort((a,b)=>String(b.data).localeCompare(String(a.data)));

      if(!vis.length){
        el.innerHTML = "";
        empty.style.display = "block";
        sumBox.style.display = "none";
        return;
      }

      empty.style.display = "none";
      sumBox.style.display = "block";
      totalEl.textContent = moeda(soma(vis));

      el.innerHTML = vis.map(g=>`
        <div class="item">
          <div class="it-left">
            <div class="it-title">${esc(g.descricao || g.categoria || "")}</div>
            <div class="it-sub">${dataBR(g.data)} ‚Ä¢ ${esc(g.categoria||"")} ${g.forma?("‚Ä¢ "+esc(g.forma)):""}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="it-val">${moeda(g.valor)}</div>
            <button class="danger" style="width:auto;padding:8px 10px;margin:0" onclick="__del('${g.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join("");
    }

    // Lista render (ganhos)
    function renderGanhos(){
      const box = document.getElementById("listaGanhos");
      const empty = document.getElementById("emptyGanhos");
      if(!box || !empty) return;

      const vis = ganhos.slice().sort((a,b)=>String(b.data).localeCompare(String(a.data)));

      if(!vis.length){
        box.innerHTML = "";
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";
      box.innerHTML = vis.map(g=>`
        <div class="item">
          <div class="it-left">
            <div class="it-title">${esc(g.descricao || g.tipo || "")}</div>
            <div class="it-sub">${dataBR(g.data)} ‚Ä¢ ${esc(g.tipo||"")}</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center">
            <div class="it-val">${moeda(g.valor)}</div>
            <button class="danger" style="width:auto;padding:8px 10px;margin:0" onclick="__delGanho('${g.id}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join("");
    }

    // Relat√≥rio render
    function renderRelatorio(){
      const mes = relMes.value;
      const sumRel = document.getElementById("sumRel");
      const totalRel = document.getElementById("totalRel");
      const detalhe = document.getElementById("detalheCategorias");
      const empty = document.getElementById("emptyRel");
      const info = document.getElementById("infoRel");
      const exportBtns = document.getElementById("exportBtns");

      const sumGanhos = document.getElementById("sumGanhos");
      const totalGanhosEl = document.getElementById("totalGanhos");
      const sumSaldo = document.getElementById("sumSaldo");
      const saldoEl = document.getElementById("saldoMes");

      if(!mes){
        sumRel.style.display = "none";
        detalhe.style.display = "none";
        exportBtns.style.display = "none";
        info.style.display = "none";
        empty.style.display = "block";
        sumGanhos.style.display = "none";
        sumSaldo.style.display = "none";
        return;
      }

      const arr = gastos.filter(g=>g.anoMes===mes);
      const total = soma(arr);
      totalRel.textContent = moeda(total);
      sumRel.style.display = "block";
      empty.style.display = "none";

      const arrGanhos = ganhos.filter(g=>g.anoMes===mes);
      const totalGanhos = soma(arrGanhos);
      totalGanhosEl.textContent = moeda(totalGanhos);
      sumGanhos.style.display = "block";

      const saldo = totalGanhos - total;
      saldoEl.textContent = moeda(saldo);
      sumSaldo.style.display = "block";

      if(!total && !totalGanhos){
        detalhe.style.display = "none";
        exportBtns.style.display = "none";
        info.style.display = "none";
        return;
      }

      exportBtns.style.display = "flex";
      info.textContent = `M√™s: ${mes} ‚Ä¢ Gastos: ${arr.length} ‚Ä¢ Ganhos: ${arrGanhos.length}`;
      info.style.display = "block";

      if(!total){
        detalhe.style.display = "none";
        return;
      }

      const map = {};
      for(const g of arr){
        const cat = g.categoria || "Outros";
        const v = Number(g.valor)||0;
        if(!map[cat]) map[cat] = {cat,total:0,itens:[],qtd:0,min:v,max:v};
        map[cat].total += v;
        map[cat].qtd += 1;
        map[cat].min = Math.min(map[cat].min, v);
        map[cat].max = Math.max(map[cat].max, v);
        map[cat].itens.push({
          data: g.data || "",
          desc: (g.descricao && String(g.descricao).trim()) ? String(g.descricao).trim() : "(sem descri√ß√£o)",
          forma: g.forma || "",
          valor: v
        });
      }

      const cats = Object.values(map).sort((a,b)=>b.total-a.total);
      cats.forEach(c=>{
        c.itens.sort((a,b)=>String(b.data).localeCompare(String(a.data)) || (b.valor-a.valor));
      });

      detalhe.innerHTML = cats.map(c=>{
        const pct = total ? (c.total/total*100) : 0;
        const media = c.qtd ? (c.total/c.qtd) : 0;

        const itens = c.itens.map(it=>`
          <div class="cat-item">
            <div class="left">
              <div class="desc">${esc(it.desc)}</div>
              <div class="sub">${dataBR(it.data)}${it.forma?(" ‚Ä¢ "+esc(it.forma)):""}</div>
            </div>
            <div class="val">${moeda(it.valor)}</div>
          </div>
        `).join("");

        return `
          <details>
            <summary>
              <div>
                <div class="cat-name">${esc(c.cat)}</div>
                <div class="cat-meta">Qtd: ${c.qtd} ‚Ä¢ M√©dia: ${moeda(media)} ‚Ä¢ Menor: ${moeda(c.min)} ‚Ä¢ Maior: ${moeda(c.max)}</div>
              </div>
              <div>
                <div class="cat-total">${moeda(c.total)}</div>
                <div class="cat-pct">${pct.toFixed(1)}%</div>
              </div>
            </summary>
            <div class="cat-items">${itens}</div>
          </details>
        `;
      }).join("");

      detalhe.style.display = "block";
    }

    // Export CSV + PDF
    document.getElementById("btnPdf").addEventListener("click", ()=>window.print());

    document.getElementById("btnCsv").addEventListener("click", ()=>{
      const mes = relMes.value;
      if(!mes){ alert("Selecione um m√™s."); return; }

      const arrGastos = gastos.filter(g=>g.anoMes===mes).sort((a,b)=>String(a.data).localeCompare(String(b.data)));
      const arrGanhos = ganhos.filter(g=>g.anoMes===mes).sort((a,b)=>String(a.data).localeCompare(String(b.data)));

      const totalGastos = soma(arrGastos);
      const totalGanhos = soma(arrGanhos);
      const saldo = totalGanhos - totalGastos;

      const SEP=";";
      const EOL="\r\n";
      const BOM="\ufeff";
      const escCsv = (s)=> `"${String(s??"").replaceAll('"','""')}"`;
      const num = (n)=> String(Number(n||0).toFixed(2)).replace(".",",");

      let csv = BOM + `sep=${SEP}` + EOL;
      csv += `Relat√≥rio${SEP}${escCsv(mes)}${EOL}${EOL}`;

      csv += `GANHOS${EOL}`;
      csv += `Data${SEP}Tipo${SEP}Descri√ß√£o${SEP}Valor${EOL}`;
      for(const g of arrGanhos){
        csv += `${escCsv(dataBR(g.data))}${SEP}${escCsv(g.tipo)}${SEP}${escCsv(g.descricao)}${SEP}${num(g.valor)}${EOL}`;
      }
      csv += `Total de ganhos${SEP}${SEP}${SEP}${num(totalGanhos)}${EOL}${EOL}`;

      csv += `GASTOS${EOL}`;
      csv += `Data${SEP}Categoria${SEP}Descri√ß√£o${SEP}Forma${SEP}Valor${EOL}`;
      for(const g of arrGastos){
        csv += `${escCsv(dataBR(g.data))}${SEP}${escCsv(g.categoria)}${SEP}${escCsv(g.descricao)}${SEP}${escCsv(g.forma)}${SEP}${num(g.valor)}${EOL}`;
      }
      csv += `Total de gastos${SEP}${SEP}${SEP}${SEP}${num(totalGastos)}${EOL}${EOL}`;

      csv += `Saldo (ganhos - gastos)${SEP}${SEP}${SEP}${SEP}${num(saldo)}${EOL}`;

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `Relatorio_${mes}.csv`;
      a.click();
    });

    // Auth flow init
    async function init(){
      show(loginOverlay, true);
      setStatus("Sincroniza√ß√£o: desconectada");

      try { await getRedirectResult(auth); } catch (_) {}

      if(sessionStorage.getItem(PENDING_PIN_RESET)==="1"){
        sessionStorage.removeItem(PENDING_PIN_RESET);
        localStorage.removeItem(PIN_HASH_KEY);
        unlocked = false;
        show(pinOverlay,true);
        pinMode("set");
      }

      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          userUid = null;
          unlocked = false;
          if(unsub){ unsub(); unsub=null; }
          if(unsubGanhos){ unsubGanhos(); unsubGanhos=null; }
          btnLogout.style.display = "none";
          btnChangePin.style.display = "none";
          setStatus("Sincroniza√ß√£o: desconectada");
          show(loginOverlay,true);
          return;
        }

        userUid = user.uid;
        show(loginOverlay,false);
        startSync();

        await requirePin();
      });
    }

    init();
  </script>
</body>
</html>
